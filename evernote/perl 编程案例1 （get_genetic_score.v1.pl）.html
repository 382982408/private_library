<html>
<head>
  <title>perl 编程案例1 （get_genetic_score.v1.pl）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="420"/>
<h1>perl 编程案例1 （get_genetic_score.v1.pl）</h1>

<div>
<span><div><span style="font-size: 16pt; color: rgb(227, 0, 0);">perl 编程案例1 （get_genetic_score.v1.pl）</span></div><div>#!/usr/bin/perl -w</div><div><br/></div><div>=head1 Usage:</div><div><br/></div><div>    perl get_genetic_score.v1.pl</div><div>    -handel        family information file</div><div>            #原序号    性别    家系定位    是否患病    家系定位(矫正后)</div><div>            9BZ212    FM    先证者    4(患病)    daughter</div><div>            9BZ213    FM    母    0(不患病)    mother</div><div>            9BZ214    M    父    0(不患病)    father</div><div>    -table        family depth table</div><div>            #突变    gene    NM    OMIM    遗传方式    9BZ212    9BZ214    9BZ213</div><div>            chr17_32965285_32965286_-_A    TMEM132E    NM_207313    NA    NA    4/25=0.16;Hete;杂合;不可靠    16/40=0.4;Hete;杂合;不可靠    0/35=0;Wild;野生型;NA</div><div>            chr4_167675226_167675226_G_A    SPOCK3    NM_001204358    NA    NA    0/37=0;Wild;野生型;NA    0/40=0;Wild;野生型;NA    26/53=0.49;Hete;杂合;可能不可靠</div><div>            chr2_179579093_179579093_T_C    TTN    NM_133432    OMIM:611705    AR    107/107=1;Homo;纯合;特别可靠    116/116=1;Homo;纯合;特别可靠    60/119=0.5;Hete;杂合;特别可靠</div><div>    -o        output file</div><div><br/></div><div>=head2 Note:</div><div><br/></div><div>    此程序用于遗传学判定分析.</div><div>    This program is used to analyze genetics.</div><div>    1)    单报告模式和家系模式都可以用此程序进行遗传学判定。遗传学判定忽略是否有OMIM疾病，无OMIM疾病的按照显隐性分别分析.</div><div>    2)    先证者 &quot;不可靠&quot; 的变异不参与复合杂合判定,复合杂合判定忽略遗传方式，只要是杂合变异，均参与复合杂合判定.</div><div>    3)    table输入文件中除了先证者&quot;不可靠&quot; 的变异之外，其余所有变异，无论生物学级别为几级，都会参与复合杂合判定，因此，满足复合杂合的结果会比WES流程中多许多.</div><div>    4)    复合杂合中，只有AR隐性遗传并且父母正常的情况才满足共分离，其余的复合杂合不属于共分离。(XR复合杂合暂时不考虑共分离)</div><div>    5)    &quot;是否denovo&quot;列中结果展示为&quot;0|1&quot;,第一个0表示严格来说非denovo，第二个1表示当家系成员补齐的时候也有可能是denovo.</div><div>    6)    &quot;是否复合杂合&quot;列中结果展示为&quot;0|1&quot;,第一个0表示严格来说非复合杂合，第二个1表示当家系成员补齐的时候也有可能是复合杂合.</div><div><br/></div><div>=cut</div><div><br/></div><div><br/></div><div>use strict;</div><div>use File::Basename;</div><div>use Getopt::Long;</div><div>use FindBin qw($Bin $Script);</div><div>use Data::Dumper;</div><div><br/></div><div>######################################################</div><div><br/></div><div>&amp;main();</div><div><br/></div><div>sub main</div><div>{</div><div>    ####遗传判定中标签信息文件</div><div>    my $tran_file=&quot;/share/chg2master/EXdev/WES_pipe_v4/db/Z_lzw_database/for_report_convert.txt_chinese&quot;;</div><div>    ####遗传判定结论信息文件</div><div>    my $fam_MS=&quot;/share/chg2master/EXdev/WES_pipe_v4/pipeline/Family_report/9.0_models/family_MS_chinese&quot;;</div><div>    my $pro_MS=&quot;/share/chg2master/EXdev/WES_pipe_v4/pipeline/Family_report/9.0_models/proband_MS_chinese&quot;;</div><div><br/></div><div><br/></div><div>    ####输入输出参数获取</div><div>    my ($relation_file,$table,$out);</div><div>    GetOptions</div><div>    (</div><div>        &quot;handel=s&quot;=&gt;\$relation_file,</div><div>        &quot;table=s&quot;=&gt;\$table,</div><div>        &quot;o=s&quot;=&gt;\$out,</div><div>    );</div><div>    die `pod2text $0` if(!defined $relation_file || !defined $table || !defined $out);</div><div><br/></div><div>    print STDOUT &quot;work start ...\n&quot;;</div><div>    ####读取家系info配置信息</div><div>    print &quot;read family relationships...\n&quot;;</div><div>    my %relation;</div><div>    &amp;read_sinfo($relation_file,\%relation);</div><div>    print Dumper \%relation;</div><div><br/></div><div>    ####整理家系信息，按照分辨先证者，父亲，母亲，其他人</div><div>    my @samples =sort keys %relation;</div><div>    my (@sons,@father,@mother,@other,@all);</div><div>    my $famflag;</div><div>        ####1表示三个人标准家系</div><div>        ####2表示三个人标准家系+另外子女</div><div>        ####3表示三个人标准家系+另外亲戚</div><div>        ####4表示三个人标准家系+另外子女+另外亲戚</div><div>        ####5表示先证者+父亲+母亲缺少一个或者多个的非标准家系</div><div>    &amp;fam_info_rearr(\@samples,\%relation,\@sons,\@father,\@mother,\@other,\$famflag);</div><div>    push @all,@sons,@father,@mother,@other;</div><div>    print Dumper \@all;</div><div><br/></div><div>    ####读取判定需要配置信息</div><div>    my %translation;</div><div>    &amp;read_hash($tran_file,\%translation,1,2,1);</div><div>    &amp;read_hash($fam_MS,\%translation,1,&quot;2,3,4&quot;,1);</div><div>    &amp;read_hash($pro_MS,\%translation,1,&quot;2,3,4&quot;,1);    ####单个人的遗传判定打分与家系稍有调整,覆盖之</div><div><br/></div><div>    ####读取变异深度信息</div><div>    my %dep_info;</div><div>    &amp;read_mut_dep_info($table,\%dep_info);</div><div><br/></div><div>    ####按照严格的成员先手顺序整理变异信息（先证者+父亲+母亲+其他人）</div><div>    my $head_table=(join &quot;\t&quot;,&quot;####突变\tgene\tNM\tOMIM\t遗传方式&quot;,@all).&quot;\n&quot;;</div><div>    my $info_table=&amp;dep_info_rearr(\%dep_info,\@all);</div><div>    &amp;write_out(&quot;$out\_table&quot;,$head_table.$info_table);</div><div><br/></div><div>    ####复合杂合判定</div><div>    my (%comp_hete,$comp_content,$comp_tmp);</div><div>    if ($famflag&lt;=4)</div><div>    {</div><div>        if ((defined $father[0]) &amp;&amp; (exists $relation{$father[0]}) &amp;&amp; (exists $relation{$father[0]}{'path'}) &amp;&amp; $relation{$father[0]}{'path'}=~/4/)</div><div>        {</div><div>            ####父亲患病，非严格的标准家系</div><div>            ($comp_tmp,$comp_content)=&amp;get_comp_hete($head_table.$info_table,\%relation,\%translation,&quot;fam&quot;);</div><div>        }elsif ((defined $mother[0]) &amp;&amp; (exists $relation{$mother[0]}) &amp;&amp; (exists $relation{$mother[0]}{'path'}) &amp;&amp; $relation{$mother[0]}{'path'}=~/4/)</div><div>        {</div><div>            ####母亲患病，非严格的标准家系</div><div>            ($comp_tmp,$comp_content)=&amp;get_comp_hete($head_table.$info_table,\%relation,\%translation,&quot;fam&quot;);</div><div>        }else</div><div>        {</div><div>            ####严格的标准家系</div><div>            ($comp_tmp,$comp_content)=&amp;get_comp_hete($head_table.$info_table,\%relation,\%translation,&quot;stdfam&quot;);</div><div>        };</div><div>    }elsif(@all == 1)        ###只有先证者的单报告，也要做复合杂合判定</div><div>    {</div><div>        ($comp_tmp,$comp_content)=&amp;get_comp_hete($head_table.$info_table,\%relation,\%translation,&quot;proband&quot;);</div><div>    }else</div><div>    {</div><div>        ####无先证者+父亲+母亲的非标准家系</div><div>        ($comp_tmp,$comp_content)=&amp;get_comp_hete($head_table.$info_table,\%relation,\%translation,&quot;unnorm&quot;);</div><div>    };</div><div>    %comp_hete=%{$comp_tmp};</div><div>    &amp;write_out(&quot;$out\_table_revisetag&quot;,$comp_content);</div><div><br/></div><div>    ####遗传打分</div><div>    my $head=(join &quot;\t&quot;,&quot;####突变\tgene\tNM\tOMIM\t遗传方式\t遗传打分\t结论\t依据\t判定遗传方式\t是否共分离\t是否denovo\t是否复合杂合\t复合杂合详细\trevise_tag&quot;,@all).&quot;\n&quot;;</div><div>    my $out_content_last=&amp;get_genetic(&quot;$out\_table_revisetag&quot;,\@all,\%relation,\%comp_hete,\%translation);</div><div><br/></div><div>    ####通过fhzh_type编号矫正出非严格标准的复合杂合+denovo(修正denovo标签和复合杂合标签)</div><div>    $out_content_last=&amp;get_comphete_tag_revise($head.$out_content_last);</div><div><br/></div><div>    &amp;write_out(&quot;$out&quot;,$out_content_last);</div><div><br/></div><div>    print STDOUT &quot;work end ...\n&quot;;</div><div>};</div><div><br/></div><div>###########以下都是子程序</div><div>####读取handel 配置文件信息</div><div>sub read_sinfo</div><div>{</div><div>    my ($info,$hash)=@_;</div><div>    open L,&quot;$info&quot; or die;</div><div>    while (&lt;L&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if (/^$|^\#/);</div><div>        my @arr=split /\t+/,$_;</div><div>        $arr[0]=~s/\s//g;</div><div>        $hash-&gt;{$arr[0]}{'off'}=$arr[1];        #######性别</div><div>        $hash-&gt;{$arr[0]}{'rea'}=$arr[2];        #######样本名</div><div>        $hash-&gt;{$arr[0]}{'path'}=$arr[3];        #######是否患病</div><div>        $hash-&gt;{$arr[0]}{'rel'}=$arr[4];        #######家系关系</div><div>    };</div><div>    close L;</div><div>};</div><div><br/></div><div>####获取家系深度信息</div><div>sub read_mut_dep_info</div><div>{</div><div>    my($table,$hash)=@_;</div><div>    open L,&quot;$table&quot; or die&quot;error:can not open file: $table \n\n&quot;;</div><div>    my @head;</div><div>    while (&lt;L&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if(/^$/);</div><div>        my @tmp=split /\t/,$_;</div><div>        my $mut=&quot;$tmp[0]\t$tmp[1]\t$tmp[2]\t$tmp[3]\t$tmp[4]&quot;;</div><div>        my @arr=@tmp[5..$#tmp];</div><div>        if ($_=~/^\#/)</div><div>        {</div><div>            @head=@arr;</div><div>        }else</div><div>        {</div><div>            for (my $i=0;$i&lt;@arr ;$i++)</div><div>            {</div><div>                $hash-&gt;{$mut}{$head[$i]}=$arr[$i];</div><div>            };</div><div>        };</div><div>    };</div><div>    close L;</div><div>};</div><div><br/></div><div>####按照严格的成员先手顺序整理变异信息（先证者+父亲+母亲+其他人）</div><div>sub dep_info_rearr</div><div>{</div><div>    my($dep_info,$all)=@_;</div><div>    my $out;</div><div>    foreach my $key (sort keys %{$dep_info})</div><div>    {</div><div>        my @out;</div><div>        push @out,$key;</div><div>        foreach my $name (@{$all})</div><div>        {</div><div>            $name=~s/\s+//g;</div><div>            if (not exists $dep_info-&gt;{$key}{$name})</div><div>            {</div><div>                print STDERR &quot;error:\tno dep information of $name ($key) !!!\n&quot;;</div><div>                print Dumper \%{$dep_info};</div><div>                die;</div><div>            };</div><div>            push @out,$dep_info-&gt;{$key}{$name};</div><div>        };</div><div>        $out.=(join &quot;\t&quot;,@out).&quot;\n&quot;;</div><div>    };</div><div>    return $out;</div><div>};</div><div><br/></div><div>####重新整理家系信息</div><div>sub fam_info_rearr</div><div>{</div><div>    my($samples,$relation,$sons,$father,$mother,$other,$famflag)=@_;</div><div>    foreach my $name (@{$samples})</div><div>    {</div><div>            my $tmp=$relation-&gt;{$name}{'rel'};</div><div>            if (!$tmp)</div><div>            {</div><div>                    print STDERR &quot;please check you Sinfo_config_file !\t$name\n\n&quot;;</div><div>                    print Dumper \%{$relation};</div><div>                    die;</div><div>            };</div><div>            if ($tmp=~/son|daughter/i &amp;&amp; @{$sons}&lt;1 &amp;&amp; $relation-&gt;{$name}{'rea'}=~/先证者/)</div><div>            {</div><div>                    push @{$sons},$name;</div><div>                    if ($relation-&gt;{$name}{path}=~/0|2/)</div><div>                    {</div><div>                        print STDERR &quot;error: the proband is normal !!!\n\n&quot;;</div><div>                        die;</div><div>                    };</div><div>            }elsif($tmp=~/father/i)</div><div>            {</div><div>                    push @{$father},$name;</div><div>            }elsif($tmp=~/mother/i)</div><div>            {</div><div>                    push @{$mother},$name;</div><div>            }else</div><div>            {</div><div>                    push @{$other},$name;</div><div>            };</div><div>    };</div><div><br/></div><div>    if ((@{$sons}==1) &amp;&amp; (@{$father}==1) &amp;&amp; (@{$mother}==1) &amp;&amp; @{$other}==0)</div><div>    {</div><div>            $$famflag=1;</div><div>            print STDOUT &quot;standard_family of one child...\n&quot;;</div><div>    }elsif((@{$sons}&gt;=1) &amp;&amp; (@{$father}==1) &amp;&amp; (@{$mother}==1) &amp;&amp; @{$other}==0)</div><div>    {</div><div>            $$famflag=2;</div><div>            print STDOUT &quot;standard_family or many children...\n&quot;;</div><div>    }elsif((@{$sons}==1) &amp;&amp; (@{$father}==1) &amp;&amp; (@{$mother}==1) &amp;&amp; @{$other}&gt;=1)</div><div>    {</div><div>            $$famflag=3;</div><div>            print STDOUT &quot;standard_family of one child! + others relatives...\n&quot;;</div><div>    }elsif((@{$sons}&gt;=1) &amp;&amp; (@{$father}==1) &amp;&amp; (@{$mother}==1) &amp;&amp; @{$other}&gt;=1)</div><div>    {</div><div>            $$famflag=4;</div><div>            print STDOUT &quot;standard_family of many children! + others relatives...\n&quot;;</div><div>    }else</div><div>    {</div><div>            $$famflag=5;</div><div>            print STDOUT &quot;unstandard_family... \n&quot;;</div><div>    };</div><div>};</div><div><br/></div><div>####文件读取函数(输入文件，存入哈希，key列，value列，哈希维度)</div><div>sub read_hash</div><div>{</div><div>    my ($file,$hash,$key,$value,$type)=@_;</div><div>    if (!defined $type)</div><div>    {</div><div>        $type=1;</div><div>    };</div><div>    open L,&quot;$file&quot; or die &quot;\n\tcan not open file: $file !!!\n\n&quot;;</div><div>    while (&lt;L&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if (/^$/ || /^#/);</div><div>        my @arr=split /\t/,$_;</div><div>        #######################</div><div>        my ($VALUE,@VALUE);</div><div>        if ($value eq &quot;0&quot;)</div><div>        {</div><div>            $VALUE=$_;</div><div>        }else</div><div>        {</div><div>            my @value_vols=split /\,/,$value;</div><div>            foreach my $vol (@value_vols)</div><div>            {</div><div>                if($vol &gt;0)</div><div>                {</div><div>                    push @VALUE,$arr[$vol-1];</div><div>                }else</div><div>                {</div><div>                    push @VALUE,$arr[$vol];</div><div>                };</div><div>            };</div><div>            if(!defined $VALUE[0])</div><div>            {</div><div>                print &quot;error:$file !\n&quot;;</div><div>                die;</div><div>            }</div><div>            $VALUE=join &quot;\t&quot;,@VALUE;</div><div>        };</div><div>        if (!defined $VALUE)</div><div>        {</div><div>            print STDERR &quot;\n\tfile error: $file \n\t$_\n\n&quot;;</div><div>            die;</div><div>        };</div><div>        ##########################</div><div>        my @key_vols=split /\,/,$key;</div><div>        if ($type==1)</div><div>        {</div><div>            my ($KEY,@KEY);</div><div>            foreach my $vol (@key_vols)</div><div>            {</div><div>                if($vol &gt;0)</div><div>                {</div><div>                    if (!defined $arr[$vol-1])</div><div>                    {</div><div>                        print STDERR &quot;\n\tfile error: $file\n\t$_\nnum:$key\n$value\n&quot;;</div><div>                        die;</div><div>                    };</div><div>                    push @KEY,$arr[$vol-1];</div><div>                }else</div><div>                {</div><div>                    if (!defined $arr[$vol])</div><div>                    {</div><div>                        print STDERR &quot;\n\tfile error: $file\n\t$_\nnum:$key\n$value\n&quot;;</div><div>                        die;</div><div>                    };</div><div>                    push @KEY,$arr[$vol];</div><div>                };</div><div>            };</div><div>            $KEY=join &quot;\t&quot;,@KEY;</div><div>            if (!defined $KEY)</div><div>            {</div><div>                print Dumper \@KEY;</div><div>                print STDERR &quot;\n\tfile error: $file\n\t$_\nnum:$key\n$value\n&quot;;</div><div>                die;</div><div>            };</div><div>            $hash-&gt;{$KEY}=$VALUE;</div><div>        }elsif($type==2 &amp;&amp; @key_vols==2)</div><div>        {</div><div>            my $tmp_1;</div><div>            my $tmp_2;</div><div>            if($key_vols[0] &gt;0)</div><div>            {</div><div>                $tmp_1=$key_vols[0]-1;</div><div>            }else</div><div>            {</div><div>                $tmp_1=$key_vols[0];</div><div>            };</div><div>            if($key_vols[1] &gt;0)</div><div>            {</div><div>                $tmp_2=$key_vols[1]-1;</div><div>            }else</div><div>            {</div><div>                $tmp_2=$key_vols[1];</div><div>            };</div><div>            </div><div>            if (!defined $arr[$tmp_1] || !defined $arr[$tmp_2])</div><div>            {</div><div>                print STDERR &quot;\n\tfile error: $file \n\t$_\n\n&quot;;</div><div>                die;</div><div>            };</div><div>            $hash-&gt;{$arr[$tmp_1]}{$arr[$tmp_2]}=$VALUE;</div><div>        }elsif($type==3 &amp;&amp; @key_vols==3)</div><div>        {</div><div>            my $tmp_1;</div><div>            my $tmp_2;</div><div>            my $tmp_3;</div><div>            if($key_vols[0] &gt;0)</div><div>            {</div><div>                    $tmp_1=$key_vols[0]-1;</div><div>            }else</div><div>            {</div><div>                    $tmp_1=$key_vols[0];</div><div>            };</div><div>            if($key_vols[1] &gt;0)</div><div>            {</div><div>                    $tmp_2=$key_vols[1]-1;</div><div>            }else</div><div>            {</div><div>                    $tmp_2=$key_vols[1];</div><div>            };</div><div>            if($key_vols[2] &gt;0)</div><div>            {</div><div>                    $tmp_3=$key_vols[2]-1;</div><div>            }else</div><div>            {</div><div>                    $tmp_3=$key_vols[2];</div><div>            };</div><div><br/></div><div>            if (!defined $arr[$tmp_1] || !defined $arr[$tmp_2] || !defined $arr[$tmp_3])</div><div>            {</div><div>                print STDERR &quot;\n\tfile error: $file \n\t$_\n\n&quot;;</div><div>                die;</div><div>            };</div><div>            $hash-&gt;{$arr[$tmp_1]}{$arr[$tmp_2]}{$arr[$tmp_3]}=$VALUE;</div><div>        }else</div><div>        {</div><div>            print STDERR &quot;\n\tfile error: $file \n\t$_\n\n&quot;;</div><div>            die;</div><div>        };</div><div>    };</div><div>    close L;</div><div>};</div><div><br/></div><div>####文件输出函数</div><div>sub write_out</div><div>{</div><div>    my ($out,$info)=@_;</div><div>    open OUT,&quot;&gt;$out&quot; or die &quot;error:can not open file $out\n\n&quot;;</div><div>    if (!defined $info || $info=~/^$/)</div><div>    {</div><div>        print STDERR &quot;error:$out is error !!!\n&quot;;</div><div>        die;</div><div>    };</div><div>    print OUT &quot;$info&quot;;</div><div>    close OUT;</div><div>};</div><div><br/></div><div>####遗传学意义判定</div><div>####my $out_content_last=&amp;get_genetic(&quot;$out\_table_revisetag&quot;,\@all,\%relation,\%comp_hete,\%translation);</div><div>sub get_genetic</div><div>{</div><div>    my ($in,$name,$relation,$comp_hete,$trans)=@_;</div><div>    ###############</div><div>    my $fam_member=&quot;no&quot;;</div><div>    my $other_member=&quot;no&quot;;</div><div>    foreach my $tmp_name (@{$name})</div><div>    {</div><div>        if ((exists $relation-&gt;{$tmp_name}{rel}) &amp;&amp; $relation-&gt;{$tmp_name}{rel}=~/father|mother/)</div><div>        {</div><div>            $fam_member=&quot;yes&quot;;</div><div>        }elsif((exists $relation-&gt;{$tmp_name}{rel}) &amp;&amp; $relation-&gt;{$tmp_name}{rel}=~/other/)</div><div>        {</div><div>            $other_member=&quot;yes&quot;;</div><div>        };</div><div>    };</div><div>    ###########</div><div>    my $outcontent;</div><div>    open L,&quot;$in&quot; or die&quot;error:can not open file: $in \n\n&quot;;</div><div>    while(&lt;L&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if(/^$|^\#/);</div><div>        my @arr=split /\t/,$_;</div><div>        my $key=$arr[0];</div><div>        my $only_key=&quot;$arr[0]\t$arr[1]\t$arr[2]\t$arr[3]&quot;;</div><div>#        next if($key !~ /chr17_2965285_2965285_A_C/);</div><div><br/></div><div>        my ($ori_yichuan,$yichuan)=split /\|/,$arr[4];</div><div>        my $gene=$arr[1];</div><div>        my ($value,$jielun,$yiju,$totscore,$AD,$co_ex,$denovo,$fuhezahe,$com_detail)=(&quot;NA&quot;,&quot;NA&quot;,&quot;NA&quot;,&quot;NA&quot;,&quot;NA&quot;,&quot;-1&quot;,&quot;-1&quot;,&quot;-1&quot;,&quot;NA&quot;);</div><div><br/></div><div>        ###遗传判定不看OMIM疾病非否为空</div><div>        {</div><div>            my %for_gen_score;</div><div>            foreach my $ad (split /[,，；;]/,$yichuan)</div><div>            {</div><div>                next if($ad=~/^$/);</div><div>                if ($key=~/chrX/)</div><div>                {</div><div>                    if ($ad=~/AD|AR|Y/)</div><div>                    {</div><div>                        $ad=&quot;XD&quot;;</div><div>                    };</div><div>                }elsif($key=~/chrY/)</div><div>                {</div><div>                    $ad=&quot;Y&quot;;</div><div>                }else</div><div>                {</div><div>                    if ($ad=~/XD|XR|Y/)</div><div>                    {</div><div>                        $ad=&quot;AD&quot;;</div><div>                    };</div><div>                };</div><div>                my ($tmp_value,$tmp_jielun,$tmp_yiju,$tmp_totscore,$tmp_co_ex,$tmp_denovo,$tmp_fuhezahe,$tmp_com_detail)=(&quot;NA&quot;,&quot;NA&quot;,&quot;NA&quot;,&quot;NA&quot;,&quot;-1&quot;,&quot;-1&quot;,&quot;-1&quot;,&quot;NA&quot;);</div><div>                my $ad_dig;</div><div>                if ($ad=~/AD/)</div><div>                {</div><div>                    $ad_dig=1;</div><div>                }elsif($ad=~/AR/)</div><div>                {</div><div>                    $ad_dig=2;</div><div>                }elsif($ad=~/XD|XL/)</div><div>                {</div><div>                    $ad_dig=3;</div><div>                }elsif($ad=~/XR/)</div><div>                {</div><div>                    $ad_dig=4;</div><div>                }elsif($ad=~/Y|Y-linked/)</div><div>                {</div><div>                    $ad_dig=5;</div><div>                }else</div><div>                {</div><div>                    print STDERR &quot;genetic error: $_\n$ad\n&quot;;</div><div>                    die;</div><div>                };</div><div>                #############################</div><div>                my($P,$F,$O)=(&quot;Perr&quot;,&quot;F3&quot;,&quot;O3&quot;);</div><div>                my($p_detail,$f_detail,$o_detail)=(&quot;NA&quot;,&quot;NA&quot;,&quot;NA&quot;);</div><div>                for (my $i=0;$i&lt;@{$name} ;$i++)</div><div>                {</div><div>                    my $name=$$name[$i];</div><div>                    my $homo=$arr[$i+5];</div><div>                    if ($homo=~/Homo/i)</div><div>                    {</div><div>                        $homo=&quot;1&quot;;</div><div>                    }elsif($homo=~/Hete/i)</div><div>                    {</div><div>                        $homo=&quot;2&quot;;</div><div>                    }elsif($homo=~/Uncov/i)</div><div>                    {</div><div>                        $homo=&quot;3&quot;;</div><div>                    }elsif($homo=~/Wild/i)</div><div>                    {</div><div>                        $homo=&quot;4&quot;;</div><div>                    }elsif($homo=~/Hemi/i)</div><div>                    {</div><div>                        $homo=&quot;5&quot;;</div><div>                    }else</div><div>                    {</div><div>                        print STDERR &quot;muttype_error:$_\n&quot;;</div><div>                        die;</div><div>                    };</div><div>                    my $sex=$relation-&gt;{$name}{off};</div><div>                    if ($sex=~/^FM/)</div><div>                    {</div><div>                        $sex=1;</div><div>                    }else</div><div>                    {</div><div>                        $sex=2;</div><div>                    };</div><div>                    my $path=$relation-&gt;{$name}{path};</div><div>                    my $tmpresult=&quot;F&quot;.$ad_dig.$sex.$homo.$path;</div><div>                    if (not exists $trans-&gt;{$tmpresult})</div><div>                    {</div><div>                        print STDERR &quot;error:$_\n$tmpresult\n&quot;;</div><div>                        die;</div><div>                    }else</div><div>                    {</div><div>                        $tmpresult=$trans-&gt;{$tmpresult};</div><div>                    };</div><div>                    if ($i==0)</div><div>                    {</div><div>                        if(exists $comp_hete-&gt;{denovo}{$only_key})</div><div>                        {</div><div>                            if ($comp_hete-&gt;{denovo}{$only_key}=~/p_3/)</div><div>                            {</div><div>                                $tmp_denovo=1;</div><div>                                $f_detail.=&quot;$comp_hete-&gt;{denovo}{$only_key}&quot;;</div><div>                                $o_detail.=&quot;$comp_hete-&gt;{denovo}{$only_key}&quot;;</div><div>                            }elsif($comp_hete-&gt;{denovo}{$only_key}=~/p/)</div><div>                            {</div><div>                                $tmp_denovo=1;</div><div>                                $f_detail.=&quot;$comp_hete-&gt;{denovo}{$only_key}&quot;;</div><div>                                $o_detail.=&quot;$comp_hete-&gt;{denovo}{$only_key}&quot;;</div><div>                            }elsif($comp_hete-&gt;{denovo}{$only_key}=~/NO/)</div><div>                            {</div><div>                                $tmp_denovo=0;</div><div>                            }elsif($comp_hete-&gt;{denovo}{$only_key}=~/unknown/)</div><div>                            {</div><div>                                $tmp_denovo=-1;</div><div>                            }else</div><div>                            {</div><div>                                print STDERR &quot;error:denovo info err $only_key !\t$comp_hete-&gt;{denovo}{$only_key}\n&quot;;</div><div>                                die;</div><div>                            };</div><div>                        }else</div><div>                        {</div><div>                            print STDERR &quot;error:no denovo info of $only_key !\n&quot;;</div><div>                            die;</div><div>                        };</div><div><br/></div><div>                        my $uniq=&quot;NA&quot;;</div><div>                        if ($homo=~/2/ &amp;&amp; (exists $comp_hete-&gt;{hete}{$only_key}))</div><div>                        {</div><div>                            $tmp_fuhezahe=$comp_hete-&gt;{hete}{$only_key};</div><div>                            if ($tmp_fuhezahe=~/n_1/)</div><div>                            {</div><div>                                $uniq=&quot;YES&quot;;</div><div>                            };</div><div>                            if ($ad=~/AR/ &amp;&amp; $tmp_fuhezahe=~/stdfam/)    ####XR上的复合杂合先不处理</div><div>                            {</div><div>                                $f_detail.=$tmp_fuhezahe;</div><div>                                $o_detail.=$tmp_fuhezahe;</div><div>                            };</div><div>                        }elsif($homo=~/2/ &amp;&amp; ($arr[5]=~/\;不可靠|\;Unreliable/ || $gene=~/chr/ || $key=~/upd|SMN/))</div><div>                        {</div><div>                            ####不可靠变异,upd，大片段CNV 不参与复合杂合判定，因此，都当做单杂合来判定</div><div>                            $uniq=&quot;YES&quot;;</div><div>                        }elsif($homo=~/2/)</div><div>                        {</div><div>                            print STDERR &quot;error:AR hete $_\n\n&quot;;</div><div>                            die;</div><div>                        };</div><div>                        $f_detail.=&quot;$tmpresult&quot;;</div><div>                        $o_detail.=&quot;$tmpresult&quot;;</div><div>                        $P=&amp;get_genetic_conclusion($homo,$ad,$uniq,$tmp_denovo,$tmp_fuhezahe);</div><div>                        if ($P=~/err/i)</div><div>                        {</div><div>                            print STDERR &quot;error:$_\n$homo\t$ad\t$uniq\t$tmp_denovo\t$tmp_fuhezahe\n&quot;;</div><div>                            die;</div><div>                        };</div><div>                    }elsif((exists $relation-&gt;{$name}{rel}) &amp;&amp; $relation-&gt;{$name}{rel}=~/father|mother/)</div><div>                    {</div><div>                        $f_detail.=&quot;;$tmpresult&quot;;</div><div>                    }elsif((exists $relation-&gt;{$name}{rel}) &amp;&amp; $relation-&gt;{$name}{rel}=~/other/)</div><div>                    {</div><div>                        $o_detail.=&quot;;$tmpresult&quot;;</div><div>                    }else</div><div>                    {</div><div>                        print STDERR &quot;error:fam_relation_error in $name\n&quot;;</div><div>                        die;</div><div>                    };</div><div>                };</div><div>                my $result_tag;</div><div>                if ($fam_member=~/yes/)</div><div>                {</div><div>                    ($result_tag,$F)=split /\|/,&amp;get_fam_conclusion($f_detail,$trans,$key);</div><div>                };</div><div>                </div><div>                if ($other_member=~/yes/)</div><div>                {</div><div>                    ($result_tag,$O)=split /\|/,&amp;get_fam_conclusion($o_detail,$trans,$key);</div><div>                    $O=~s/F/O/;</div><div>                };</div><div><br/></div><div>                #########################</div><div>                if (exists $trans-&gt;{&quot;$P:$F:$O&quot;})</div><div>                {</div><div>                    ($tmp_value,$tmp_jielun,$tmp_yiju)=split /\t/,$trans-&gt;{&quot;$P:$F:$O&quot;};</div><div>                }else</div><div>                {</div><div>                    print STDERR &quot;depend error ! \t$P:$F:$O\t$key\n&quot;;</div><div>                    die;</div><div>                };</div><div>                ##################################</div><div>                if ($tmp_value eq 1)</div><div>                {</div><div>                    $tmp_co_ex=1;</div><div>                }elsif(@{$name} &gt; 1)</div><div>                {</div><div>                    $tmp_co_ex=0;</div><div>                }else</div><div>                {</div><div>                    $tmp_co_ex=-1;</div><div>                };</div><div><br/></div><div>                ##################################</div><div>                if($tmp_value=~/err/)</div><div>                {</div><div>                    print STDERR &quot;error:$key\t$P:$F:$O\t$p_detail\t$f_detail\t$o_detail\n$tmp_value\t$tmp_jielun\t$tmp_yiju\t$tmp_totscore\n&quot;;</div><div>                    die;</div><div>                };</div><div><br/></div><div>                if ($tmp_fuhezahe=~/m\(/ &amp;&amp; $tmp_fuhezahe=~/stdfam/ &amp;&amp; $ad=~/AR/)    ####XR上的复合杂合先不处理</div><div>                {</div><div>                    if ($tmp_fuhezahe=~/m\(/ &amp;&amp; $tmp_fuhezahe=~/fam/)</div><div>                    {</div><div>                        $tmp_com_detail=$tmp_fuhezahe;</div><div>                        $tmp_com_detail=~s/\t/\,/g;</div><div>                        $tmp_fuhezahe=1;</div><div>                    }elsif((@{$name} &gt; 1) || ($arr[5]!~/Hete/i))</div><div>                    {</div><div>                        $tmp_fuhezahe=0;</div><div>                    }else</div><div>                    {</div><div>                        $tmp_fuhezahe=-1;</div><div>                    };</div><div><br/></div><div>                    push @{$for_gen_score{hete}},$tmp_value,$tmp_jielun,$tmp_yiju,$tmp_totscore,$ad,$tmp_co_ex,$tmp_denovo,$tmp_fuhezahe,$tmp_com_detail;</div><div>                }else</div><div>                {</div><div>                    if ($tmp_fuhezahe=~/m\(/ &amp;&amp; $tmp_fuhezahe=~/fam/)</div><div>                    {</div><div>                        $tmp_com_detail=$tmp_fuhezahe;</div><div>                        $tmp_com_detail=~s/\t/\,/g;</div><div>                        $tmp_fuhezahe=1;</div><div>                    }elsif((@{$name} &gt; 1) || ($arr[5]!~/Hete/i))</div><div>                    {</div><div>                        $tmp_fuhezahe=0;</div><div>                    }else</div><div>                    {</div><div>                        $tmp_fuhezahe=-1;</div><div>                    };</div><div><br/></div><div>                    if($ad=~/ADIP/ &amp;&amp; $tmp_value=~/4/ &amp;&amp; $tmp_yiju=~/考虑不完全外显|ADIP/)</div><div>                    {</div><div>                        $tmp_value=2;</div><div>                        $tmp_jielun=$trans-&gt;{path_support};</div><div>                    };</div><div>                    push @{$for_gen_score{value}{$tmp_value}},$tmp_value,$tmp_jielun,$tmp_yiju,$tmp_totscore,$ad,$tmp_co_ex,$tmp_denovo,$tmp_fuhezahe,$tmp_com_detail;</div><div>                };</div><div>            };</div><div>            ######################################</div><div>            if (exists $for_gen_score{hete})</div><div>            {</div><div>                ($value,$jielun,$yiju,$totscore,$AD,$co_ex,$denovo,$fuhezahe,$com_detail)=@{$for_gen_score{hete}};</div><div>            }else</div><div>            {</div><div>                foreach my $VALUE (sort {$a &lt;=&gt; $b} keys %{$for_gen_score{value}})</div><div>                {</div><div>                    ($value,$jielun,$yiju,$totscore,$AD,$co_ex,$denovo,$fuhezahe,$com_detail)=@{$for_gen_score{value}{$VALUE}};</div><div>                    last;</div><div>                };</div><div>            };</div><div>        };</div><div><br/></div><div><br/></div><div>        if($ori_yichuan=~/NA/)</div><div>        {</div><div>            my @tmp_jielun=split /；/,$yiju;</div><div>            $tmp_jielun[0]=~s/，符合/，本疾病遗传方式尚未报道，不排除其符合/;</div><div>            $tmp_jielun[0]=~s/，不符合/，本疾病遗传方式尚未报道，不排除其不符合/;</div><div>        };</div><div><br/></div><div>        if ($arr[5]=~/\;不可靠|\;Unreliable/)</div><div>        {</div><div>            $arr[-1].=&quot;;Unreliable&quot;;</div><div>        };</div><div>        $outcontent.=(join &quot;\t&quot;,@arr[0..4],$value,$jielun,$yiju,$AD,$co_ex,$denovo,$fuhezahe,$com_detail,$arr[-1],@arr[5..$#arr-1]).&quot;\n&quot;;</div><div>    };</div><div>    close L;</div><div>    return $outcontent;</div><div>};</div><div><br/></div><div>####</div><div>sub revise_genetic</div><div>{</div><div>    my($revise_AD,$mut)=@_;</div><div>    $revise_AD=~s/X-linked|XD/XL/g;</div><div>    $revise_AD=~s/Y-linked/Y/g;</div><div>    $revise_AD=~s/DR|SOMATIC|somatic|SMu|IC|体细胞突变/NA/g;</div><div>    $revise_AD=~s/\s+//g;</div><div>    my @ADS;</div><div>    if ($revise_AD=~/AD|AR|XD|XR|Y|XL/)</div><div>    {</div><div>        my @tmp_ADS=split /[,，;\，]/,$revise_AD;</div><div>        for (my $j=0;$j&lt;@tmp_ADS ;$j++)</div><div>        {</div><div>            if ($mut=~/chrX|NC_000023/)</div><div>            {</div><div>                    $tmp_ADS[$j]=~s/AD|AR|Y|Y-link/XL/g;</div><div>            }elsif($mut=~/chrY|NC_000024/)</div><div>            {</div><div>                    $tmp_ADS[$j]=~s/AD|AR|XD|XL|XR/Y-link/g;</div><div>            }else</div><div>            {</div><div>                    $tmp_ADS[$j]=~s/XD|XL|XR|Y|Y-link/AD/g;</div><div>            };</div><div>            if ($tmp_ADS[$j]=~/AD|AR|XD|XR|XL|Y/)</div><div>            {</div><div>                push @ADS,$tmp_ADS[$j];</div><div>            };</div><div>        };</div><div>    }else</div><div>    {</div><div>        if ($mut=~/chrX|NC_000023/)</div><div>        {</div><div>                @ADS=(&quot;XL&quot;,&quot;XR&quot;);</div><div>        }elsif($mut=~/chrY|NC_000024/)</div><div>        {</div><div>                @ADS=(&quot;Y-link&quot;);</div><div>        }else</div><div>        {</div><div>                @ADS=(&quot;AD&quot;,&quot;AR&quot;);</div><div>        };</div><div>    };</div><div>    if (@ADS==0)</div><div>    {</div><div>        @ADS=(&quot;NA&quot;);</div><div>    };</div><div>    $revise_AD=join &quot;,&quot;,@ADS;</div><div>};</div><div><br/></div><div>####复合杂合+denovo判定</div><div>sub get_comp_hete        ####&amp;standard_family::get_comp_hete(\@famsample,\%com,\%rmdepth,\%relation,\%tmp_hete,\%tmp_fuhezahe);</div><div>{</div><div>    my ($in,$relation,$trans,$fam_tag)=@_;</div><div>    my (%ar_hete,%result,%last);</div><div><br/></div><div>    my @arr_origin=split /\n/,$in;</div><div>    my $fhzh_content;</div><div>    my @head;</div><div>    foreach(@arr_origin)</div><div>    {</div><div>        chomp;</div><div>        next if(/^$/);</div><div>        my @arr=split /\t/,$_;</div><div>        if (/^\#/)</div><div>        {</div><div>            $fhzh_content.=&quot;$_\tfhzh_type\n&quot;;</div><div>            @head=@arr;</div><div>            next;</div><div>        };</div><div>        my $mut=$arr[0];</div><div>        my $gene=$arr[1];</div><div>        my $ori_yichuan=$arr[4];</div><div>        my $yichuan=&amp;revise_genetic($ori_yichuan,$arr[0]);</div><div><br/></div><div>        my ($son,$father,$mother)=(&quot;ALL&quot;,&quot;ALL&quot;,&quot;ALL&quot;);</div><div>        my $parent=&quot;null&quot;;</div><div>        for (my $i=5;$i&lt;8;$i++)</div><div>        {</div><div>            if (defined $head[$i] &amp;&amp; (exists $relation-&gt;{$head[$i]}) &amp;&amp; $relation-&gt;{$head[$i]}{rea}=~/先证者/)</div><div>            {</div><div>                $son=$arr[$i];</div><div>            }elsif(defined $head[$i] &amp;&amp; (exists $relation-&gt;{$head[$i]}) &amp;&amp; $relation-&gt;{$head[$i]}{rea}=~/父/)</div><div>            {</div><div>                $father=$arr[$i];</div><div>                $parent=&quot;Parent&quot;;</div><div>            }elsif(defined $head[$i] &amp;&amp; (exists $relation-&gt;{$head[$i]}) &amp;&amp; $relation-&gt;{$head[$i]}{rea}=~/母/)</div><div>            {</div><div>                $mother=$arr[$i];</div><div>                $parent=&quot;Parent&quot;;</div><div>            };</div><div>        };</div><div>        if ($son eq &quot;ALL&quot;)</div><div>        {</div><div>            print STDERR &quot;\nerror:the information of the proband is error !!!\n\n&quot;;</div><div>            die;</div><div>        };</div><div><br/></div><div>        my $fhzh_type=&quot;type_other&quot;;</div><div>        my $mut_key=&quot;$arr[0]\t$arr[1]\t$arr[2]\t$arr[3]&quot;;</div><div><br/></div><div>        if ($son=~/Hete/i &amp;&amp; $gene!~/chr/ &amp;&amp; $mut!~/upd|SMN/ &amp;&amp; $son!~/\;不可靠|\;Unreliable/) #######不可靠突变不参与复合杂合判定 by_lzw_20180518,复合杂合不考虑遗传方式</div><div>        {</div><div>            $ar_hete{$gene}{$mut}{&quot;$arr[0]\t$arr[1]\t$arr[2]\t$arr[3]&quot;}{son}=$son;</div><div>            $ar_hete{$gene}{$mut}{&quot;$arr[0]\t$arr[1]\t$arr[2]\t$arr[3]&quot;}{father}=$father;</div><div>            $ar_hete{$gene}{$mut}{&quot;$arr[0]\t$arr[1]\t$arr[2]\t$arr[3]&quot;}{mother}=$mother;</div><div>        };</div><div>        ##################</div><div>        my $muttype;</div><div>            foreach my $cy ($son,$father,$mother)</div><div>            {</div><div>                if ($cy=~/Homo/i)</div><div>                {</div><div>                    $muttype.=&quot;1&quot;;</div><div>                }elsif($cy=~/Hete/i)</div><div>                {</div><div>                    $muttype.=&quot;2&quot;;</div><div>                }elsif($cy=~/Uncov/i)</div><div>                {</div><div>                    $muttype.=&quot;3&quot;;</div><div>                }elsif($cy=~/Wild/i)</div><div>                {</div><div>                    $muttype.=&quot;4&quot;;</div><div>                }elsif($cy=~/Hemi/i)</div><div>                {</div><div>                    $muttype.=&quot;5&quot;;</div><div>                }elsif($cy=~/ALL/)</div><div>                {</div><div>                    $muttype.=&quot;4&quot;;        ####父母缺少样本的时候，默认为野生型</div><div>                }else</div><div>                {</div><div>                    print STDERR &quot;muttype_error:$_\n&quot;;</div><div>                    die;</div><div>                };</div><div>            };</div><div><br/></div><div>            if (not exists $relation-&gt;{$head[5]}{off})</div><div>            {</div><div>                print STDERR &quot;error:no sex info $head[5] !\n&quot;;</div><div>                die;</div><div>            }elsif ($relation-&gt;{$head[5]}{off}=~/FM/)</div><div>            {</div><div>                $muttype.=&quot;-1&quot;;</div><div>            }else</div><div>            {</div><div>                $muttype.=&quot;-2&quot;;</div><div>            };</div><div><br/></div><div>            if ($yichuan=~/AD|AR/)</div><div>            {</div><div>                $muttype.=&quot;-1&quot;;</div><div>            }elsif ($yichuan=~/XD|XR|XL|X-linked/)</div><div>            {</div><div>                $muttype.=&quot;-3&quot;;</div><div>            }elsif ($yichuan=~/Y/)</div><div>            {</div><div>                $muttype.=&quot;-5&quot;;</div><div>            }else</div><div>            {</div><div>                print STDERR &quot;yichuan_error:$yichuan\n$_\n&quot;;</div><div>                die;</div><div>            };</div><div><br/></div><div>            if($fam_tag=~/fam/ &amp;&amp; $muttype=~/144|244|544/)    ##只有标准家系，父母均野生型的变异才给denovo</div><div>            {</div><div>                if (not exists $trans-&gt;{$muttype})</div><div>                {</div><div>                    print STDERR &quot;error :denovo error:$mut\t$gene\t$muttype !!!\n$_\n&quot;;</div><div>                    die;</div><div>                };</div><div>                $last{denovo}{$mut_key}=$trans-&gt;{$muttype};</div><div>            }elsif($fam_tag=~/fam/)        ####只有在有父母样本的时候才会做家系矫正</div><div>            {</div><div>                $last{denovo}{$mut_key}=&quot;NO&quot;;</div><div>            }else</div><div>            {</div><div>                $last{denovo}{$mut_key}=&quot;unknown&quot;;</div><div>            };</div><div>            ###########################################</div><div>            ##    杂合+杂合+野生型  &gt;类型1 type_1</div><div>            ##    杂合+野生型+杂合  &gt;类型2 type_2</div><div>            ##    其它&gt;不复合复合杂合   &gt; type_other</div><div>            if ($muttype=~/224|254/ &amp;&amp; $mut!~/upd/ &amp;&amp; $gene!~/SMN1/ &amp;&amp; $gene!~/chr/)</div><div>            {</div><div>                $fhzh_type=&quot;type_1&quot;;</div><div>            }elsif($muttype=~/242/ &amp;&amp; $mut!~/upd/ &amp;&amp; $gene!~/SMN1/ &amp;&amp; $gene!~/chr/)</div><div>            {</div><div>                $fhzh_type=&quot;type_2&quot;;</div><div>            }elsif($muttype=~/244/ &amp;&amp; $mut!~/upd/ &amp;&amp; $gene!~/SMN1/ &amp;&amp; $gene!~/chr/)</div><div>            {</div><div>                $fhzh_type=&quot;type_1,type_2&quot;;</div><div>            };</div><div>        ########################</div><div>        $arr[4].=&quot;|$yichuan&quot;;</div><div>        $_=join &quot;\t&quot;,@arr;</div><div>        $fhzh_content.=&quot;$_\t$fhzh_type;denovo$muttype;$parent\n&quot;;</div><div>    };</div><div>    close L;</div><div>    ########################################</div><div>    ########################################</div><div>    foreach my $gene (keys %ar_hete)</div><div>    {</div><div>        if ((keys %{$ar_hete{$gene}}) &lt; 2)</div><div>        {</div><div>            foreach my $key (keys %{$ar_hete{$gene}})</div><div>            {</div><div>                foreach my $only_key (keys %{$ar_hete{$gene}{$key}})</div><div>                {</div><div>                    push @{$result{$key}{$gene}{$only_key}},'e_2,n_1';</div><div>                };</div><div>            };</div><div>        }elsif($fam_tag=~/stdfam|fam|proband/)</div><div>        {</div><div>            foreach my $key11 (sort keys %{$ar_hete{$gene}})</div><div>            {</div><div>                foreach my $only_key11 (sort keys %{$ar_hete{$gene}{$key11}})</div><div>                {</div><div>                    if (($ar_hete{$gene}{$key11}{$only_key11}{father}=~/Homo|Uncov/i) || ($ar_hete{$gene}{$key11}{$only_key11}{mother}=~/Homo|Uncov/i))</div><div>                    {</div><div>                        push @{$result{$key11}{$gene}{$only_key11}},&quot;$fam_tag,e_2,n_2&quot;;</div><div>                        next;</div><div>                    }elsif (($ar_hete{$gene}{$key11}{$only_key11}{father}=~/Hete|Hemi/i) &amp;&amp; ($ar_hete{$gene}{$key11}{$only_key11}{mother}=~/Hete|Hemi/i))</div><div>                    {</div><div>                        push @{$result{$key11}{$gene}{$only_key11}},&quot;$fam_tag,e_2,n_2&quot;;</div><div>                        next;</div><div>                    }else</div><div>                    {</div><div>                        my $tag=0;</div><div>                        foreach my $key22 (sort keys %{$ar_hete{$gene}})</div><div>                        {</div><div>                            next if ($key11 eq $key22);</div><div>                            foreach my $only_key22 (sort keys %{$ar_hete{$gene}{$key22}})</div><div>                            {</div><div>                                if (($ar_hete{$gene}{$key22}{$only_key22}{father}=~/Homo|Uncov/i) || ($ar_hete{$gene}{$key22}{$only_key22}{mother}=~/Homo|Uncov/i))</div><div>                                {</div><div>                                    next;</div><div>                                }elsif (($ar_hete{$gene}{$key22}{$only_key22}{father}=~/Hete|Hemi/i) &amp;&amp; ($ar_hete{$gene}{$key22}{$only_key22}{mother}=~/Hete|Hemi/i))</div><div>                                {</div><div>                                    next;</div><div>                                }elsif(($ar_hete{$gene}{$key11}{$only_key11}{father}=~/Hete|Hemi/i) &amp;&amp; ($ar_hete{$gene}{$key22}{$only_key22}{father}=~/Hete|Hemi/i))</div><div>                                {</div><div>                                    next;</div><div>                                }elsif(($ar_hete{$gene}{$key11}{$only_key11}{mother}=~/Hete|Hemi/i) &amp;&amp; ($ar_hete{$gene}{$key22}{$only_key22}{mother}=~/Hete|Hemi/i))</div><div>                                {</div><div>                                    next;</div><div>                                }else</div><div>                                {</div><div>                                    $tag=1;</div><div>                                    push @{$result{$key11}{$gene}{$only_key11}},&quot;$fam_tag,e_2,m($only_key22)&quot;;</div><div>                                };</div><div>                            };</div><div>                        };</div><div>                        if ($tag==0)</div><div>                        {</div><div>                            push @{$result{$key11}{$gene}{$only_key11}},&quot;$fam_tag,e_2,n_2&quot;;</div><div>                        };</div><div>                    };</div><div>                };</div><div>            };</div><div>        }else</div><div>        {</div><div>            foreach my $key (keys %{$ar_hete{$gene}})</div><div>            {</div><div>                foreach my $only_key (keys %{$ar_hete{$gene}{$key}})</div><div>                {</div><div>                    push @{$result{$key}{$gene}{$only_key}},'e_2,n_2';</div><div>                };</div><div>            };</div><div>        };</div><div>    };</div><div>    #############################</div><div>    foreach my $KEY (sort keys %result)</div><div>    {</div><div>        foreach my $gene(sort keys %{$result{$KEY}})</div><div>        {</div><div>            foreach my $only_KEY (sort keys %{$result{$KEY}{$gene}})</div><div>            {</div><div>                $last{hete}{$only_KEY}=join &quot;;&quot;,&amp;get_uniq(@{$result{$KEY}{$gene}{$only_KEY}});</div><div>            };</div><div>        };</div><div>    };</div><div>    ################    &amp;exon::write_out(&quot;$in\_revise&quot;,$fhzh_content);</div><div>    return (\%last,$fhzh_content);</div><div>};</div><div><br/></div><div>####去重复</div><div>sub get_uniq</div><div>{</div><div>    my @TMP=@_;</div><div>    my (%uniq,@tmp);</div><div>    foreach my $A (@TMP)</div><div>    {</div><div>        next if(!defined $A || $A=~/^$/);</div><div>        if (not exists $uniq{$A})</div><div>        {</div><div>            push @tmp,$A;</div><div>            $uniq{$A}=1;</div><div>        };</div><div>    };</div><div>    return @tmp;</div><div>};</div><div><br/></div><div>####获取先证者遗传判定结论</div><div>sub get_genetic_conclusion</div><div>{</div><div>    my($HOMO,$AD,$uniq,$denovo,$fuhezahe)=@_;</div><div>    my $return=&quot;ERR&quot;;</div><div>    if($denovo==1)</div><div>    {</div><div>            if($HOMO=~/homo|纯合|1/i)</div><div>            {</div><div>                if ($AD=~/AD/)</div><div>                {</div><div>                    $return=&quot;P19&quot;;</div><div>                }elsif($AD=~/AR/)</div><div>                {</div><div>                    $return=&quot;P20&quot;;</div><div>                }elsif($AD=~/XD|X-linked|XL/)</div><div>                {</div><div>                    $return=&quot;P21&quot;;</div><div>                }elsif($AD=~/XR/)</div><div>                {</div><div>                    $return=&quot;P22&quot;;</div><div>                };</div><div>            }elsif($HOMO=~/hete|杂合|2/i)</div><div>            {</div><div>                if ($AD=~/AD/)</div><div>                {</div><div>                    $return=&quot;P26&quot;;</div><div>                }elsif($AD=~/AR/)</div><div>                {</div><div>                    $return=&quot;P27&quot;;</div><div>                    if ($uniq=~/YES/)</div><div>                    {</div><div>                        $return=&quot;P9&quot;;</div><div>                    }elsif($fuhezahe=~/m\(/)</div><div>                    {</div><div>                        $return=&quot;P10&quot;;</div><div>                    }else</div><div>                    {</div><div>                        $return=&quot;P11&quot;;</div><div>                    };</div><div>                }elsif($AD=~/XD|X-linked|XL/)</div><div>                {</div><div>                    $return=&quot;P28&quot;;</div><div>                }elsif($AD=~/XR/)</div><div>                {</div><div>                    $return=&quot;P29&quot;;</div><div>                };</div><div>            }elsif($HOMO=~/hemi|半合子|5/i)</div><div>            {</div><div>                if ($AD=~/Y/)</div><div>                {</div><div>                    $return=&quot;P23&quot;;</div><div>                }elsif($AD=~/XD|X-linked|XL/)</div><div>                {</div><div>                    $return=&quot;P24&quot;;</div><div>                }elsif($AD=~/XR/)</div><div>                {</div><div>                    $return=&quot;P25&quot;;</div><div>                };</div><div>            };</div><div>    }elsif($HOMO=~/homo|纯合|1/i)</div><div>    {</div><div>        if ($AD=~/AD/)</div><div>        {</div><div>            $return=&quot;P1&quot;;</div><div>        }elsif($AD=~/AR/)</div><div>        {</div><div>            $return=&quot;P2&quot;;</div><div>        }elsif($AD=~/XD|X-linked|XL/)</div><div>        {</div><div>            $return=&quot;P3&quot;;</div><div>        }elsif($AD=~/XR/)</div><div>        {</div><div>            $return=&quot;P4&quot;;</div><div>        };</div><div>    }elsif($HOMO=~/hete|杂合|2/i)</div><div>    {</div><div>        if ($AD=~/AD/)</div><div>        {</div><div>            $return=&quot;P8&quot;;</div><div>        }elsif($AD=~/AR/)</div><div>        {</div><div>            if ($uniq=~/YES/)</div><div>            {</div><div>                $return=&quot;P9&quot;;</div><div>            }elsif($fuhezahe=~/m\(/)</div><div>            {</div><div>                $return=&quot;P10&quot;;</div><div>            }else</div><div>            {</div><div>                $return=&quot;P11&quot;;</div><div>            };</div><div>        }elsif($AD=~/XD|X-linked|XL/)</div><div>        {</div><div>            $return=&quot;P12&quot;;</div><div>        }elsif($AD=~/XR/)</div><div>        {</div><div>            $return=&quot;P13&quot;;</div><div>        };</div><div>    }elsif($HOMO=~/hemi|半合子|5/i)</div><div>    {</div><div>        if ($AD=~/Y/)</div><div>        {</div><div>            $return=&quot;P5&quot;;</div><div>        }elsif($AD=~/XD|X-linked|XL/)</div><div>        {</div><div>            $return=&quot;P6&quot;;</div><div>        }elsif($AD=~/XR/)</div><div>        {</div><div>            $return=&quot;P7&quot;;</div><div>        };</div><div>    }elsif($HOMO=~/wild|野生型|4/i)</div><div>    {</div><div>        if ($AD=~/AD/)</div><div>        {</div><div>            $return=&quot;P14&quot;;</div><div>        }elsif($AD=~/AR/)</div><div>        {</div><div>            $return=&quot;P15&quot;;</div><div>        }elsif($AD=~/XD|X-linked|XL/)</div><div>        {</div><div>            $return=&quot;P16&quot;;</div><div>        }elsif($AD=~/XR/)</div><div>        {</div><div>            $return=&quot;P17&quot;;</div><div>        }elsif($AD=~/Y/)</div><div>        {</div><div>            $return=&quot;P18&quot;;</div><div>        };</div><div>    }elsif($HOMO=~/uncov|未覆盖|3/i)</div><div>    {</div><div>        $return=&quot;P34&quot;;</div><div>    };</div><div>    return $return;</div><div>};</div><div><br/></div><div>####获取家系成员遗传判定结论</div><div>sub get_fam_conclusion</div><div>{</div><div>    my ($tag,$hash,$mut,$res,$fuhezahe)=@_;</div><div>    $res='NA|ERR';</div><div>    if($tag=~/e_1/)</div><div>    {</div><div>        $res=&quot;F|F2&quot;;</div><div>    }elsif($tag=~/e_2/)</div><div>    {</div><div>        if($tag=~m/m(\(.*?\))/)</div><div>        {</div><div>            $res='B|F1';</div><div>            $fuhezahe=$1;</div><div>        }elsif($tag=~/n_1/)</div><div>        {</div><div>            $res='E_1|F2';</div><div>        }elsif($tag=~/n_2/)</div><div>        {</div><div>            $res='E_2|F2';</div><div>        }else</div><div>        {</div><div>            $res=&quot;F|F2&quot;;</div><div>        };</div><div>    }elsif($tag=~/d/)</div><div>    {</div><div>        $res='G|F6';</div><div>    }elsif($tag=~/b/)</div><div>    {</div><div>        $res='C|F4';</div><div>    }elsif($tag=~/c/)</div><div>    {</div><div>        $res='D|F5';</div><div>    }elsif($tag=~/a/)</div><div>    {</div><div>        $res='A|F1';</div><div>    }elsif($tag=~/z/)</div><div>    {</div><div>        $res='mutation_in_XX_chrY|F3';</div><div>    };</div><div>    return $res;</div><div>};</div><div><br/></div><div>####通过fhzh_type编号矫正出非严格标准的复合杂合+denovo</div><div>sub get_comphete_tag_revise</div><div>{</div><div>    my ($content)=@_;</div><div>    my $return;</div><div><br/></div><div>    my @CONTENT=split /\n/,$content;</div><div>    ##############</div><div>    my %info;</div><div>    my %info_gene_mut_num;</div><div>    foreach my $i(0..@CONTENT-1)</div><div>    {</div><div>        my @arr=split /\t/,$CONTENT[$i];</div><div>        my $mut_id=$arr[0];</div><div>        my $gene=$arr[1];</div><div>        if ($arr[13]!~/Unreliable/ &amp;&amp; $gene!~/chr/)        #####不可靠突变不参与复合杂合判定</div><div>        {</div><div>            $info{$gene}.=&quot;$mut_id;$arr[13];&quot;;</div><div>            if ($arr[13]=~/type_1|type_2/)</div><div>            {</div><div>                $info_gene_mut_num{$gene}{$mut_id}=1;</div><div>            };</div><div>        };</div><div>    };</div><div>    ###########################</div><div>    foreach my $i(0..@CONTENT-1)</div><div>    {</div><div>        if ($CONTENT[$i] =~ /^\#/)</div><div>        {</div><div>            $return.=&quot;$CONTENT[$i]\n&quot;;</div><div>            next;</div><div>        };</div><div>        my @arr=split /\t/,$CONTENT[$i];</div><div>        my $mut_id=$arr[0];</div><div>        my $gene=$arr[1];</div><div><br/></div><div>        if ($arr[13]!~/Unreliable/ &amp;&amp; $gene!~/chr/ &amp;&amp; (not exists $info{$gene}))</div><div>        {</div><div>            print STDERR &quot;error:no compehete info $gene:$CONTENT[$i]\n&quot;;</div><div>            die;</div><div>        };</div><div><br/></div><div>        my $gene_mut_number=keys %{$info_gene_mut_num{$gene}};</div><div><br/></div><div>        if ($arr[13]!~/Unreliable/ &amp;&amp; $arr[13]=~/Parent/ &amp;&amp; $arr[13]=~/type_1|type_2/ &amp;&amp; (exists $info{$gene}) &amp;&amp; $info{$gene}=~/type_1/ &amp;&amp; $info{$gene}=~/type_2/ &amp;&amp; $gene_mut_number &gt;= 2)</div><div>        {</div><div>            $arr[11].=&quot;|1&quot;;        ####复合杂合矫正</div><div>        }else</div><div>        {</div><div>            $arr[11].=&quot;|0&quot;;</div><div>        };</div><div><br/></div><div>        if ($arr[13]=~/denovo144|denovo244|denovo544/ &amp;&amp; $arr[13]=~/Parent/)    ###双亲必须要有一个</div><div>        {</div><div>            $arr[10].=&quot;|1&quot;;        ####denovo矫正</div><div>        }else</div><div>        {</div><div>            $arr[10].=&quot;|0&quot;;</div><div>        };</div><div><br/></div><div>        $return.=(join &quot;\t&quot;,@arr).&quot;\n&quot;;</div><div>    };</div><div>    return $return;</div><div>};</div><div><br/></div></span>
</div></body></html> 