<html>
<head>
  <title>perl 编程案例5 （PBS 任务投递）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="413"/>
<h1>perl 编程案例5 （PBS 任务投递）</h1>

<div>
<span><div><span style="font-size: 14pt; color: rgb(255, 0, 0);">perl 编程案例5 （PBS 任务投递）</span></div><div><br/></div><div>#!/usr/bin/perl -w</div><div><br/></div><div>=head1 Name</div><div><br/></div><div>  qsub-sge.pl -- control processes running on linux SGE system</div><div><br/></div><div>=head1 Usage</div><div>  </div><div>  perl qsub-sge.pl</div><div>  --queue        &lt;essential&gt;:Specify the work queue! &lt;example:sge01&gt;</div><div>  --node        &lt;essential&gt;:Specify the work node!  &lt;example:node-0-09&gt;</div><div>  --wait        &lt;unessential&gt;:Specify the task delivery interval! &lt;default:30&gt;</div><div>  --interval         &lt;unessential&gt;:Specify the task check interval! &lt;default:30&gt;</div><div>  --maxproc        &lt;unessential&gt;:Set the maximum number of process! &lt;default:20&gt;</div><div>  --reqsub        &lt;unessential&gt;:Wehther to reqsub the unfinished jobs untill they are finished? &lt;default:no&gt;</div><div>  --resource        &lt;unessential&gt;:Set the required resource used in qsub -l option! &lt;default:vf=3.0G&gt;</div><div>  --independent        &lt;unessential&gt;:Wehther to contain other qsub tasks when set the max number of process? &lt;default:no&gt;</div><div>  --Check        &lt;unessential&gt;:Wehther to check last qsub uncomplete to continue? &lt;default:yes&gt;</div><div>  --help        &lt;unessential&gt;:help</div><div>=cut</div><div><br/></div><div>use strict;</div><div>use Getopt::Long;</div><div>use FindBin qw($Bin $Script);</div><div>use File::Basename qw(basename dirname);</div><div>use Data::Dumper;</div><div>use lib &quot;$Bin/../pipeline/models/&quot;;</div><div>use standard_family;</div><div>use exon;</div><div>################</div><div>my $CONF_file=&quot;$Bin/../db/Z_lzw_database/CONFIG_ALL.txt&quot;;</div><div>my %parameters;</div><div>&amp;exon::initialize($CONF_file,\%parameters);</div><div><br/></div><div>############</div><div>##get options from command line into variables and set default values</div><div>my ($Queue, $Interval,$wait,$Maxjob, $Maxproc,$Secure,$Reqsub,$Resource,$Independent,$check,$node,$Help);</div><div>GetOptions(</div><div>    &quot;maxproc:i&quot;=&gt;\$Maxproc,</div><div>    &quot;interval:i&quot;=&gt;\$Interval,</div><div>    &quot;wait:s&quot;=&gt;\$wait,</div><div>    &quot;queue:s&quot;=&gt;\$Queue,</div><div>    &quot;node:s&quot;=&gt;\$node,</div><div>    &quot;reqsub:s&quot;=&gt;\$Reqsub,</div><div>    &quot;resource:s&quot;=&gt;\$Resource,</div><div>    &quot;independent:s&quot;=&gt;\$Independent,</div><div>    &quot;Check=s&quot;=&gt;\$check,</div><div>    &quot;help&quot;=&gt;\$Help</div><div>);</div><div>$Interval ||= 30;</div><div>$wait ||= 30;</div><div>$Maxproc ||=20;</div><div>$Resource ||= &quot;mf=3.0G&quot;;</div><div>$check ||=&quot;yes&quot;;</div><div>$Independent ||=&quot;no&quot;;</div><div>$Reqsub ||=&quot;no&quot;;</div><div><br/></div><div>my $work_shell_file=shift;</div><div><br/></div><div>die `pod2text $0` if ($Help || (!defined $Queue &amp;&amp; !defined $node) || !defined $work_shell_file);</div><div><br/></div><div>####################################################</div><div>##########################################################</div><div>$work_shell_file=`readlink -f $work_shell_file`;</div><div>chomp $work_shell_file;</div><div><br/></div><div>&amp;work_check($work_shell_file,$Queue,$node);</div><div>############################################</div><div><br/></div><div>my $Work_dir = $work_shell_file.&quot;.qsub&quot;;</div><div>my $work_shell_file_error=$work_shell_file.&quot;.error&quot;;</div><div><br/></div><div>my $work_shell_file_name=basename($work_shell_file);</div><div>if ($work_shell_file_name=~m/^\d+/)</div><div>{</div><div>    print &quot;The shell file name can not begin with a number !\n&quot;;</div><div>    exit;</div><div>};</div><div>$work_shell_file_name=~s/\.sh$//;</div><div><br/></div><div>my $qstatname=$work_shell_file_name; ##add independent by heh 2012-5-16</div><div>$qstatname=substr($work_shell_file_name,0,10) if(length$qstatname&gt;10);</div><div><br/></div><div>my $current_dir=`pwd`;</div><div>chomp $current_dir;</div><div>my @Shell;</div><div><br/></div><div>if(($check eq &quot;no&quot;) &amp;&amp; (-d $Work_dir))</div><div>{</div><div>    print STDOUT &quot;jobs maybe running !!!!\n&quot;;</div><div>    exit;</div><div>}elsif(($check eq &quot;yes&quot;) &amp;&amp; (-d $Work_dir))</div><div>{</div><div>    my @old_shell=glob(&quot;$Work_dir/*.sh&quot;);</div><div>    foreach my $old_shell (sort @old_shell)</div><div>    {</div><div>                next if (-f &quot;$old_shell.Check&quot;);</div><div>                push @Shell,$old_shell;</div><div>    };</div><div>    print &quot;Check last time qsub have &quot;,scalar@Shell,&quot; shell uncomplete.\n&quot;;</div><div>    print &quot;That will continue the uncomplete jobs.\n&quot;;</div><div>}else</div><div>{</div><div>    my $Job_mark=&quot;00001&quot;;</div><div>    `mkdir -p $Work_dir` if(!-d $Work_dir);</div><div><br/></div><div>    open IN, $work_shell_file || die &quot;fail open $work_shell_file&quot;;</div><div>    while(&lt;IN&gt;)</div><div>    {</div><div>        chomp;</div><div>        next unless($_!~/^$/);</div><div><br/></div><div>        my $jobsh=&quot;$Work_dir/$work_shell_file_name\_$Job_mark.sh&quot;;</div><div>        push @Shell,&quot;$jobsh&quot;;</div><div><br/></div><div>        open OUT,&quot;&gt;$jobsh&quot; || die &quot;\n\tfailed creat $jobsh \n\n&quot;;</div><div>        print OUT $_.&quot; &amp;&amp; echo This-Work-is-Completed! &gt;$jobsh.Check\n&quot;;</div><div>        close OUT;</div><div>        $Job_mark++;</div><div>    };</div><div>    close IN;</div><div>    print STDOUT &quot;make the qsub shell files done\n&quot;;</div><div>};</div><div><br/></div><div>## run jobs by qsub, until all the jobs are really finished</div><div>my $qsub_cycle = 1;</div><div>while (@Shell&gt;0)</div><div>{</div><div><br/></div><div>    my %Alljob; ## store all the job IDs of this cycle</div><div>    my %Runjob; ## store the real running job IDs of this cycle</div><div><br/></div><div>    $Resource=~m/mf=(.+)G/;</div><div>    my $job_cmd = &quot;qsub -cwd -S /bin/bash  &quot;;  ## -l h_vmem=16G,s_core=8</div><div>    $job_cmd .= &quot;-l $Resource&quot; ; ##set resource</div><div>    if (defined $node)</div><div>    {</div><div>        $job_cmd .=&quot;,h=$node&quot;;</div><div>    }elsif(defined $Queue)</div><div>    {</div><div>        $job_cmd .=&quot;,q=$Queue&quot;;</div><div>    };</div><div><br/></div><div>    my $task=0;</div><div>    for (my $i=0; $i&lt;@Shell; $i++)</div><div>    {</div><div>        while (1)</div><div>        {</div><div>            if (&amp;queueJob() &lt; $Maxproc)</div><div>            {</div><div>                if ($wait&gt;0 &amp;&amp; $task&gt;0)</div><div>                {</div><div>                    sleep $wait;</div><div>                };</div><div><br/></div><div>                my $running_check=&amp;running_check(&quot;prod&quot;,$Shell[$i]);</div><div><br/></div><div>                if($running_check=~/yes/)</div><div>                {</div><div>                    print STDOUT &quot;job $Shell[$i] is running yet !!!\n&quot;;</div><div>                }else</div><div>                {</div><div>                    my @error_file=glob(&quot;$Shell[$i].{e,o}*&quot;);</div><div>                    `rm @error_file ` if(@error_file&gt;0);</div><div><br/></div><div>                    chdir($Work_dir);</div><div>                    my $jod_return = `$job_cmd $Shell[$i]`;</div><div>                    print STDOUT &quot;$job_cmd $Shell[$i] \n&quot;;</div><div>                    my $job_id = $1 if($jod_return =~ /Your job (\d+)/);</div><div>                    $Alljob{$job_id} = $Shell[$i];  ## job id =&gt; shell file name</div><div>                    print STDOUT &quot;throw job $job_id in the $qsub_cycle cycle\n&quot;;</div><div>                };</div><div>                </div><div>                $task++;</div><div>                last;</div><div>            }else</div><div>            {</div><div>                print STDOUT &quot;wait for throwing next job in the $qsub_cycle cycle\n&quot;;</div><div>                sleep $Interval;</div><div>            };</div><div>        };</div><div>    };</div><div><br/></div><div>    ###waiting for all jobs fininshed</div><div>    while (1)</div><div>    {</div><div>        my $run_num = run_count(\%Alljob,\%Runjob);    </div><div>        last if($run_num == 0);;</div><div>        sleep $Interval;</div><div>    };</div><div><br/></div><div>    print STDOUT &quot;All jobs finished, in the firt cycle in the $qsub_cycle cycle\n&quot;;</div><div><br/></div><div><br/></div><div>    ##run the secure mechanism to make sure all the jobs are really completed</div><div>    open OUT, &quot;&gt;&gt;$work_shell_file_error&quot; || die &quot;fail create $$work_shell_file_error&quot;;</div><div>    my @Error;</div><div>    foreach my $job_id (sort keys %Alljob)</div><div>    {</div><div>        my $shell_file = $Alljob{$job_id};</div><div>        ##check whether the job has been killed during running time</div><div>        if (!-f &quot;$shell_file\.Check&quot;)</div><div>        {</div><div>            print OUT &quot;In qsub cycle $qsub_cycle, $shell_file may be unfinished\n&quot;;</div><div>            push @Error,$shell_file;</div><div>        };</div><div>    };</div><div><br/></div><div>    if($qsub_cycle &gt; 5)</div><div>    {</div><div>        print OUT &quot;\n\nProgram stopped because the reqsub cycle number has reached 5, the following jobs unfinished:\n&quot;;</div><div>        print OUT (join &quot;\n&quot;,@Error).&quot;\n&quot;;</div><div>        print OUT &quot;Please check carefully for what errors happen, and redo the work, good luck!&quot;;</div><div>        die &quot;\nProgram stopped because the reqsub cycle number has reached 5\n&quot;;</div><div>    };</div><div><br/></div><div>    close OUT;</div><div><br/></div><div>    @Shell = @Error;</div><div>    $qsub_cycle++;</div><div><br/></div><div>    chdir($current_dir); ##return into original directory</div><div><br/></div><div>    last unless($Reqsub=~/yes/);</div><div>};</div><div><br/></div><div>print STDOUT &quot;\nqsub-sge.pl finished\n&quot;;</div><div><br/></div><div><br/></div><div>####################################################</div><div>################### Sub Routines ###################</div><div>####################################################</div><div>sub running_check    ##(&quot;prod&quot;,&quot;$Shell[$i]&quot;);</div><div>{</div><div>    my ($account,$worksh)=@_;</div><div>    sleep 5;</div><div>    my $info=`qstat -u $account|grep $account`;</div><div>    my @jobs=split /\n/,$info;</div><div>    my %RUNNING;</div><div>    foreach (@jobs)</div><div>    {</div><div>        my @arr=split /\s+/,$_;</div><div>        my @detail=split /\n/,`qstat -j $arr[1]`;</div><div>        my $run_shell;</div><div>        foreach my $aa(@detail)</div><div>        {</div><div>            my @AA=split /\s+/,$aa;</div><div>            if($aa=~/^cwd/)</div><div>            {</div><div>                $run_shell=$AA[-1];</div><div>            }elsif($aa=~/^job_name/)</div><div>            {</div><div>                $run_shell.=&quot;/$AA[-1]&quot;;</div><div>            };</div><div>        };</div><div>#                    ####edit by wang 20180328</div><div>#        if(!-f $run_shell)</div><div>#        {</div><div>#            `qdel $arr[1]`;</div><div>#        }else</div><div>#        {</div><div>#            $RUNNING{$run_shell}=1;</div><div>#        };</div><div>#    </div><div>        $RUNNING{$run_shell}=1;</div><div>    };</div><div>    if(exists $RUNNING{$worksh})</div><div>    {</div><div>        return &quot;yes&quot;;</div><div>    }else</div><div>    {</div><div>        return &quot;no&quot;;</div><div>    };</div><div>};</div><div>########################################################</div><div>sub run_count {</div><div>    my $all_p = shift;</div><div>    my $run_p = shift;</div><div>    my $run_num = 0;</div><div><br/></div><div>    %$run_p = ();</div><div>    my $user = `whoami`; chomp $user;</div><div>    my @jobs = split /\n/,`qstat -u $user`;</div><div>    foreach my $job_line (@jobs)</div><div>    {</div><div>        $job_line =~s/^\s+//;</div><div>        next if($job_line!~/^\d+/);</div><div>        my @job_field = split /\s+/,$job_line;</div><div>        next if($job_field[3] ne $user);</div><div>        if (exists $all_p-&gt;{$job_field[0]})</div><div>        {</div><div>            my %died;</div><div>            died_nodes(\%died);</div><div>            my $node_name = &quot;NA&quot;;</div><div>            if($job_field[7] =~ /.*?\@(.*?)/)</div><div>            {</div><div>                $node_name = $1 ;</div><div>            };</div><div><br/></div><div>            if (exists $died{$node_name})</div><div>            {</div><div>                `qdel $job_field[0]`;</div><div>            }else{</div><div>                $run_p-&gt;{$job_field[0]} = $job_field[2];</div><div>                $run_num++;</div><div>            };</div><div>        };</div><div>    };</div><div>    return $run_num; ##qstat����еĴ�����������״̬�����񣬲�������Щ��������ڵ��ϵĽ�ʬ����</div><div>}</div><div><br/></div><div>##############################################################</div><div>sub queueJob</div><div>{</div><div>    my $user = `whoami`;</div><div>    chomp $user;</div><div>    my @jobs = split(&quot;\n&quot;, `qstat -u $user`);</div><div><br/></div><div>    my $jobnum = @jobs-2;</div><div>    if(defined $Independent)</div><div>    {</div><div>        my $jobs=0;</div><div>        for (my $i=2;$i&lt;@jobs ;$i++)</div><div>        {</div><div>            $jobs[$i]=~s/^\s+//;</div><div>            my ($jobid,$jobname,$state)=(split/\s+/,$jobs[$i])[0,2,4];</div><div>            if($state eq &quot;Eqw&quot;)</div><div>            {</div><div>                `qdel $jobid ` ;</div><div>                next;</div><div>            };</div><div>            $jobs++ if($jobname=~m/^$qstatname/);</div><div>        };</div><div>        $jobnum=$jobs;</div><div>    };</div><div>    return $jobnum;</div><div>};</div><div>#########################################################</div><div>sub died_nodes</div><div>{</div><div>    my $died_p = shift;</div><div><br/></div><div>    my @lines = split /\n/,`qhost`;</div><div>    shift @lines; shift @lines; shift @lines;  ##remove the first three title lines</div><div>    foreach  (@lines)</div><div>    {</div><div>        my @t = split /\s+/;</div><div>        my $node_name = $t[0];</div><div>        my $memory_use = $t[5];</div><div>        $died_p-&gt;{$node_name} = 1 if($memory_use eq '-');</div><div>    };</div><div>};</div><div>#######################################</div><div>sub work_check         ##############edit by wang---20180327</div><div>{</div><div>    my($ID,$Queue,$node)=@_;</div><div>    my $ID_dir;</div><div>    if (!defined $node)</div><div>    {</div><div>        $node=&quot;NA&quot;;</div><div>    };</div><div>    return &quot;no_check&quot;;</div><div>    if($ID=~/share\/(.*?)\//)</div><div>    {</div><div>        $ID_dir=$1;</div><div>    }else</div><div>    {</div><div>        print STDERR &quot;error:data dir is wrong !!!\n&quot;;</div><div>        die;</div><div>    };</div><div>    if (exists $parameters{$ID_dir})</div><div>    {</div><div>        if ($parameters{$ID_dir} eq $Queue)</div><div>        {</div><div><br/></div><div>        }else</div><div>        {</div><div>            print STDERR &quot;\n\tplease check your work queue and the data dir !\n$ID\n$Queue\n&quot;;</div><div>            die;</div><div>        };</div><div>    }else</div><div>    {</div><div>        print STDERR &quot;\n\tplease check your data dir:$ID!!!\n\n&quot;;</div><div>        die;</div><div>    };</div><div>};</div><div>#########################################################</div><div><br/></div></span>
</div></body></html> 