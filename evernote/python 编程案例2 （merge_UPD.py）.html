<html>
<head>
  <title>python 编程案例2 （merge_UPD.py）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="429"/>
<h1>python 编程案例2 （merge_UPD.py）</h1>

<div>
<span><div><span style="font-size: 16pt; color: rgb(227, 0, 0);">python 编程案例2 （merge_UPD.py）</span></div><div><br/></div><div>#!/share/chg2master/EXdev/WES_pipe_v4/bin/Anaconda/bin/python3</div><div>import sys</div><div>import os</div><div>import re</div><div>import logging</div><div>import argparse</div><div>import subprocess</div><div><br/></div><div># import numpy as np</div><div>from collections import defaultdict</div><div>from operator import itemgetter</div><div>from pprint import pprint</div><div>from glob import glob</div><div><br/></div><div>HELP='''</div><div>    版本: 内测版,增加外显子杂合缺失和长度的过滤,增加1000个样本构建的频率库(输出频率大于0.01的区段)</div><div>          增加中间文件的生成</div><div><br/></div><div>    功能：大片段UPD分析</div><div><br/></div><div>    运行环境: &gt;=python3.6</div><div><br/></div><div>    日期：2019/3/5</div><div><br/></div><div>    by: zhongjw</div><div><br/></div><div>    '''</div><div><br/></div><div>def get_freq(upd_database,chr,start,end):</div><div>    '''</div><div>    输入染色体，起始，终止，返回频率</div><div>    '''</div><div>    freq=0</div><div>    if not os.path.exists(upd_database):</div><div>        return freq</div><div>    # 初始频率为 0</div><div>    percent = 0.5</div><div>    with open(upd_database,&quot;r&quot;) as f:</div><div>        for line in f:</div><div>            line = line.strip()</div><div>            cells = re.split('\t',line)</div><div>            if cells[0] == chr:</div><div>                # 落在区间外</div><div>                if int(end) &lt; int(cells[1]) or int(start) &gt; int(cells[2]):</div><div>                    continue</div><div>                # 相交</div><div>                elif int(end) &lt;= int(cells[2]) and int(start) &lt;= int(cells[1]):</div><div>                    if (float(end)-float(cells[1]))/(float(end)-float(start)) &gt;percent and \</div><div>                    (float(end)-float(cells[1]))/(float(end)-float(start)) &gt; percent :</div><div>                        freq = float(cells[3])</div><div>                        percent = (float(end)-float(cells[1]))/(float(end)-float(start))</div><div>                # 落在区域内</div><div>                elif int(end) &lt;= int(cells[2]) and int(start) &gt; int(cells[1]):</div><div>                    if float(cells[3]) &gt; freq:</div><div>                        freq = float(cells[3])</div><div>                        percent = 1</div><div>                # 相交</div><div>                elif  int(start) &gt; int(cells[1]) and int(end) &gt;= int(cells[2]):</div><div>                    if (float(cells[2])-float(start))/(float(end)-float(start)) &gt;percent and \</div><div>                    (float(cells[2])-float(start))/(float(end)-float(start)) &gt; percent :</div><div>                        freq = float(cells[3])</div><div>                # 包含</div><div>                elif int(start) &lt; int(cells[1]) and int(end) &gt; int(cells[2]):</div><div>                    if (float(cells[2])-float(cells[1]))/(float(end)-float(start)) &gt;percent and \</div><div>                    (float(cells[2])-float(cells[1]))/(float(end)-float(start)) &gt; percent :</div><div>                        freq = float(cells[3])</div><div>    return freq</div><div><br/></div><div><br/></div><div>def merge_UPD(b):</div><div>    len_origin=len(b)</div><div>    for i in range(0,len(b)-1):</div><div>        if i&gt;=len(b):break</div><div>        [start,end,num]=b[i]</div><div>        for j in range(i+1,len(b)-1):</div><div>            if j&gt;=len(b):break</div><div>            [next_start,next_end,next_num,ratio,ratio_left,ratio_right]=[0,0,0,0,0,0]</div><div>            [next_start,next_end,next_num]=b[j]</div><div>            ratio=(num+next_num)/(next_end-start+1+0.00)</div><div>            ratio_right=next_num/(next_end-end+0.00);</div><div>            ratio_left=num/(next_start-start+0.00);</div><div>            if next_start==end+1:</div><div>                for m in range(i,j+1):</div><div>                    del b[i]</div><div>                b.insert(i,[start,next_end,num+next_num])</div><div>            elif ratio &gt;= 0.8 and ratio_right&gt;=0.5 and ratio_left&gt;=0.5:</div><div>                for m in range(i,j+1):</div><div>                    del b[i]</div><div>                b.insert(i,[start,next_end,num+next_num])</div><div>    if len_origin != len(b):</div><div>        merge_UPD(b)</div><div>    else:</div><div>        return (1)</div><div><br/></div><div>class _newdict(dict):</div><div>    def __missing__(self,key):</div><div>        value=self[key]=type(self)()</div><div>        return (value)</div><div><br/></div><div>def read_mut_dict(file,cnvfile):</div><div>    '''</div><div>    读取输入文件,过滤掉 低于4X、突变率小于20%的突变</div><div>    返回一个字典按照染色体来存储</div><div>    '''</div><div>    bedtools = &quot;/share/chg2master/EXdev/WES_pipe_v4/bin/bedtools&quot;</div><div>    file_filter=file</div><div><br/></div><div>    if not &quot;no_cnv_file&quot; in cnvfile:</div><div>        file_filter=f&quot;{file}_cnv_filter&quot;</div><div>        cmd = f&quot;{bedtools} subtract -a {file} -b {cnvfile} -f 1 &gt; {file_filter}&quot;</div><div>        # 去掉落在外显子缺失区域的snp</div><div>        logging.info(f&quot;{cmd}&quot;)</div><div>        f = subprocess.run(cmd,shell=True,stdout=subprocess.PIPE,stderr=subprocess.PIPE)</div><div><br/></div><div>    dict = _newdict();</div><div>    for line in open(file_filter,&quot;r&quot;):</div><div>        line = line.strip()</div><div>        cells = re.split('\t|;',line)</div><div>        freq = re.split('/|=',cells[-3])</div><div>        if len(freq) != 3:</div><div>            print (cells)</div><div>            print (freq)</div><div>            sys.exit(0)</div><div>        if cells[0].startswith(&quot;#&quot;) or cells[-2].startswith(&quot;Uncov&quot;) or \</div><div>            cells[-2].startswith(&quot;Wild&quot;) or int(freq[0]) &lt; 4 or float(freq[2]) &lt; 0.2 :</div><div>            continue</div><div>        dict[cells[0]][int(cells[1])][int(cells[2])]=cells[-2]</div><div>    return dict</div><div>def check_path(*path_files):</div><div>    '''</div><div>    输入一个文件，或者路径，验证是不是真的路径</div><div>    '''</div><div>    #print(type(path_files))</div><div>    checked = []</div><div>    for file in path_files:</div><div>        if os.path.exists(file):</div><div>            checked.append(os.path.realpath(file))</div><div>        else:</div><div>            logging.error(f&quot;{file} is wrong.&quot;)</div><div>            # raise IOError(&quot;file error&quot;)</div><div>            sys.exit()</div><div><br/></div><div>    return checked</div><div><br/></div><div>def _argparses():</div><div>    parser = argparse.ArgumentParser(description='analysis large fragment UPD ')</div><div>    parser.add_argument('-i','--input',required=True,dest='input',help=&quot;input file: All_variation.vcf.annoformat&quot;)</div><div>    parser.add_argument('-o','--output',required=True,dest='output',help=&quot;output file&quot;)</div><div>    parser.add_argument('-c','--cnvfile',required=False,dest='cnvfile',help=&quot;exon_result_1.txt_CNV&quot;)</div><div>    parser.add_argument('-s','--sexfile',required=False,dest='sexfile',help=&quot;sex.txt&quot;)</div><div>    parser.add_argument('-f','--freqfile',required=False,dest='freqfile',help=&quot;upd1000_database_sorted.bed&quot;)</div><div>    parser.add_argument('-v','--version',required=False,action='store_true',help=&quot;virsion information&quot;)</div><div>#    parser.add_argument('-l','--log',required=False,dest='logfile',help=&quot;work information&quot;)</div><div>    if len(sys.argv) == 1:</div><div>       parser.print_help()</div><div>       sys.exit()</div><div>    elif '-v' in sys.argv or '--version' in sys.argv:</div><div>        print(HELP)</div><div>        sys.exit()</div><div>    return parser.parse_args()</div><div><br/></div><div>def main():</div><div>    # 可以加filename=logfile参数将日志输出到文件中</div><div>    logging.basicConfig(format='%(levelname)s %(asctime)s,line %(lineno)s:\t%(message)s',level=logging.DEBUG,datefmt='%Y-%m-%d %H:%M:%S')</div><div><br/></div><div>    argvs = _argparses()</div><div>    logging.info(&quot;work start&quot;)</div><div>    [argvs.input] = check_path(argvs.input)</div><div>    </div><div>    loss_cnv_file=&quot;no_cnv_file&quot;</div><div>    mut_dict={};</div><div>    if argvs.cnvfile != None :</div><div>        loss_cnv_file=argvs.cnvfile</div><div>    Dict_data = read_mut_dict(argvs.input,loss_cnv_file)</div><div>    #######################</div><div>    logging.info(argvs.sexfile)</div><div>    sex_test=&quot;XY&quot;</div><div>    with open(argvs.sexfile,'r') as f:</div><div>        for line in f:</div><div>            line = line.strip()</div><div>            #print(line)</div><div>            sex = re.search('sex_test:(\w\w)',line)</div><div>            if sex != None:</div><div>                sex_test = sex.group(1)</div><div>                logging.info(f&quot;sex_test:{sex_test}&quot;)</div><div>                break</div><div>    #######################</div><div>    OUT=open(argvs.output,&quot;w&quot;)</div><div>    ERR=open(argvs.output+&quot;.err&quot;,&quot;w&quot;)</div><div>    OUT.write(&quot;#mut_tag\tchr\tstart\tend\tyx_num\ttot_num\thomo_ratio\tmaf\n&quot;)</div><div>    ERR.write(&quot;#Reason\tchr\tstart\tend\tyx_num\ttot_num\thomo_ratio\tmaf\n&quot;)</div><div><br/></div><div>    for Chr in sorted(Dict_data):</div><div>        homo_idx=[]</div><div>        Dict_chr=_newdict()</div><div>        num=0</div><div>        for Start in sorted(Dict_data[Chr]):</div><div>            for End in sorted(Dict_data[Chr][Start]):</div><div>                num+=1</div><div>                Dict_chr[num]=[Chr,Start,End]</div><div>                if &quot;Homo&quot; in Dict_data[Chr][Start][End]:</div><div>                    homo_idx.append(num)</div><div>        ########################</div><div>        Chr_list=[[x,x,1] for x in homo_idx]</div><div>        merge_UPD(Chr_list)</div><div>        ########################</div><div>        for res in Chr_list:</div><div>            [Start,End,yx_num]=res</div><div>            if (Start not in Dict_chr) or (End not in Dict_chr):</div><div>                print (&quot;error:%d not in Dict_chr !\n&quot;%(Start))</div><div>                sys.exit(0)</div><div>            [tmp1_chr,tmp1_start,tmp1_end]=Dict_chr[Start]</div><div>            [tmp2_chr,tmp2_start,tmp2_end]=Dict_chr[End]</div><div>            tot_num=End-Start+1</div><div>            tot_homo_ratio=yx_num/tot_num</div><div>            if (tot_num &lt; 30):        ##########总数小于30个的，直接过滤，不用分析UPD</div><div>                continue</div><div>            freq = get_freq(argvs.freqfile,Chr,tmp1_start,tmp2_end)</div><div>            length=tmp2_end-tmp1_start</div><div>            if (&quot;XY&quot; in sex_test) and (Chr == &quot;chrX&quot; or Chr == &quot;chrY&quot;):</div><div>                continue</div><div>            if (length &lt; 5000000):</div><div>                ERR.write(f&quot;Reason:len_lt_5M\t{Chr}\t{tmp1_start}\t{tmp2_end}\t{yx_num}\t{tot_num}\t{tot_homo_ratio}\t{freq}\n&quot;)</div><div>            elif freq &gt; 0.1:</div><div>                ERR.write(f&quot;Reason:freq_gt_0.1\t{Chr}\t{tmp1_start}\t{tmp2_end}\t{yx_num}\t{tot_num}\t{tot_homo_ratio}\t{freq}\n&quot;)</div><div>            else:</div><div>                OUT.write(f&quot;{Chr}_{tmp1_start}_{tmp2_end}_chr_upd_U\t{Chr}\t{tmp1_start}\t{tmp2_end}\t{yx_num}\t{tot_num}\t{tot_homo_ratio}\t{freq}\n&quot;)</div><div>    OUT.close()</div><div>    ERR.close()</div><div>    logging.info(&quot;work done&quot;)</div><div><br/></div><div>if __name__ == '__main__':</div><div>    main()</div><div><br/></div></span>
</div></body></html> 