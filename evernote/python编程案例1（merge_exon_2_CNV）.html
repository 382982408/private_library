<html>
<head>
  <title>python编程案例1（merge_exon_2_CNV）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="423"/>
<h1>python编程案例1（merge_exon_2_CNV）</h1>

<div>
<span><div><span style="font-size: 16pt; color: rgb(255, 0, 0);">python编程案例1（merge_exon_2_CNV）</span></div><div><br/></div><div>#!/share/chg2master/EXdev/WES_pipe_v4/bin/Anaconda/bin/python3</div><div>import sys,os,re</div><div>sys.setrecursionlimit(100000)</div><div><br/></div><div>Help=&quot;&quot;&quot;</div><div>    python {0} &lt;infile&gt; &lt;outfile&gt;</div><div>&quot;&quot;&quot;.format(sys.argv[0])</div><div><br/></div><div>if len(sys.argv)&lt;3:</div><div>    print (Help)</div><div>    sys.exit(-1)</div><div>############################</div><div>class new_dict(dict):</div><div>    def __missing__(self,key):</div><div>        value=self[key]=type(self)()</div><div>        return value</div><div>def merge(b):</div><div>    len_origin=len(b)</div><div>    for i in range(0,len(b)-1):</div><div>        if i&gt;=len(b):break</div><div>        [start,end,num]=b[i]</div><div><br/></div><div>        for j in range(i+1,len(b)-1):</div><div>            if j&gt;=len(b):break</div><div>            [next_start,next_end,next_num,ratio,ratio_left,ratio_right]=[0,0,0,0,0,0]</div><div>            [next_start,next_end,next_num]=b[j]</div><div><br/></div><div><br/></div><div>#            ratio=(num+next_num)/(next_end-start+1+0.00)</div><div>#            ratio_right=next_num/(next_end-end+0.00)</div><div>#            ratio_left=num/(next_start-start+0.00)</div><div>            ####lzw@20190513 连接参数太严格了，稍微放松</div><div>            ratio=(next_end-next_start+end-start+2)/(next_end-start+1+0.00)</div><div>            ratio_right=(next_end-next_start+1)/(next_end-end+0.00)</div><div>            ratio_left=(end-start+1)/(next_start-start+0.00)</div><div><br/></div><div>            if next_start==end+1:</div><div>                for m in range(i,j+1):</div><div>                    del b[i]</div><div>                b.insert(i,[start,next_end,num+next_num])</div><div>            elif ratio &gt; 0.666666 and ratio_right&gt;=0.5 and ratio_left&gt;=0.5:</div><div>                for m in range(i,j+1):</div><div>                    del b[i]</div><div>                b.insert(i,[start,next_end,num+next_num])</div><div>    if len_origin != len(b):</div><div>        merge(b)</div><div>    else:</div><div>        return (1)</div><div>def merge_filter(b):</div><div>    list_filter=[]</div><div>    for res in b:</div><div>        [start,end,num]=res</div><div>        #####10个以上比较靠谱</div><div>        if num &gt;= 10:</div><div>            list_filter.append(res)</div><div>    return (list_filter)</div><div>##################</div><div>sys.stdout.write(&quot;work start...\n&quot;)</div><div>Dict_data=new_dict()</div><div>for line in open(sys.argv[1],&quot;r&quot;):</div><div>    line=line.strip(&quot;\n&quot;)</div><div>    [Chr,Start,End,diff,capture]=[line.split(&quot;\t&quot;)[i] for i in [0,1,2,-2,-1]]</div><div>    if &quot;#&quot; in Chr:</div><div>        continue</div><div>    Dict_data[Chr][int(Start)][int(End)]=[diff,capture]</div><div><br/></div><div>OUT=open(sys.argv[2],&quot;w&quot;)</div><div>OUT.write(&quot;#chr\tstart\tend\tlength\ttype\tdiff_ave\texon_num\texon_num_impact\texon_num_badcapture\n&quot;)</div><div>for Chr in sorted(Dict_data):</div><div>    num=0</div><div>    List_loss_idx=[]</div><div>    List_gain_idx=[]</div><div>    Dict_chr=new_dict()</div><div>    for Start in sorted(Dict_data[Chr]):</div><div>        for End in sorted(Dict_data[Chr][Start]):</div><div>            num+=1</div><div>            Dict_chr[num]=[Chr,Start,End]+Dict_data[Chr][Start][End]</div><div>            [diff,capture]=Dict_data[Chr][Start][End]</div><div>            if (not &quot;bad_capture&quot; in capture) and (not &quot;NA&quot; in diff):</div><div>                if float(diff) &lt;= 0.75:</div><div>                    List_loss_idx.append(num)</div><div>                if float(diff) &gt;= 1.25:</div><div>                    List_gain_idx.append(num)</div><div>    ###############</div><div>    for (Chr_list,yx_type) in zip([List_loss_idx,List_gain_idx],[&quot;loss&quot;,&quot;gain&quot;]):</div><div>        Chr_list=[[x,x,1] for x in Chr_list]    </div><div>        merge(Chr_list)</div><div>        Chr_list=merge_filter(Chr_list)</div><div>        ############</div><div>        for res in Chr_list:</div><div>            [Start,End,yx_num]=res</div><div>            [tmp_num,tot_diff,tot_badcapture,tmp_list]=[0,0,0,[]]</div><div>            [gain_1,gain_2,loss_1,loss_2]=[0,0,0,0]</div><div>            for i in range(Start,End+1):</div><div>                if i not in Dict_chr:print (&quot;error:%d not in Dict_chr !\n&quot;%(i))</div><div>                [tmp_chr,tmp_start,tmp_end,tmp_diff,tmp_tag]=Dict_chr[i]</div><div>                #########</div><div>                if not &quot;NA&quot; in tmp_diff:</div><div>                        if float(tmp_diff) &gt; 1.7:</div><div>                                gain_2+=1</div><div>                                gain_1+=1</div><div>                        if float(tmp_diff) &gt;= 1.25:</div><div>                                gain_1+=1</div><div>                        if float(tmp_diff) &lt; 0.15:</div><div>                                loss_2+=1</div><div>                                loss_1+=1</div><div>                        if float(tmp_diff) &lt;= 0.75:</div><div>                                loss_1+=1</div><div>                #########</div><div>                if (not &quot;NA&quot; in tmp_diff) and (not &quot;bad_capture&quot; in tmp_tag):</div><div>                    if float(tmp_diff) &gt; 2:tmp_diff=&quot;2.0&quot;</div><div>                    tot_diff+=float(tmp_diff)</div><div>                    tmp_num+=1</div><div>                if &quot;bad_capture&quot; in tmp_tag:tot_badcapture+=1</div><div>                tmp_list.extend([tmp_start,tmp_end])</div><div>            tmp_list.sort()</div><div>            last_type=&quot;unknown(gain|loss)&quot;</div><div>            ave_diff=tot_diff/(tmp_num+0.0)</div><div>            if ave_diff &gt;1.7 or gain_2/(End-Start+1)&gt;=0.8:</div><div>                last_type=&quot;gain2&quot;</div><div>            elif ave_diff &gt;= 1.2 or gain_1/(End-Start+1)&gt;=0.8:</div><div>                last_type=&quot;gain1&quot;</div><div>            elif ave_diff &lt;0.15 or loss_2/(End-Start+1)&gt;=0.8:</div><div>                last_type=&quot;loss2&quot;</div><div>            elif ave_diff &lt;= 0.8 or loss_1/(End-Start+1)&gt;=0.8:</div><div>                last_type=&quot;loss1&quot;</div><div>            if not yx_type in last_type:</div><div>                    sys.stderr.write(&quot;{0}:{1}-{2}\t{3}\t{4}\n&quot;.format(Chr,tmp_list[0],tmp_list[-1],yx_type,last_type))</div><div>                    sys.exit(-1)</div><div>            OUT.write(&quot;%s\t%s\t%s\t%d\t%s\t%f\t%d\t%d\t%d\n&quot;%(Chr,tmp_list[0],tmp_list[-1],int(tmp_list[-1])-int(tmp_list[0])+1,last_type,ave_diff,End-Start+1,yx_num,tot_badcapture))</div><div>OUT.close()</div><div>sys.stdout.write(&quot;work end...\n&quot;)</div><div><br/></div><div><br/></div></span>
</div></body></html> 