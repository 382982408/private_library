<html>
<head>
  <title>perl 编程案例9 （txt2Excel）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="398"/>
<h1>perl 编程案例9 （txt2Excel）</h1>

<div>
<span><div><span style="font-size: 12pt;">perl 编程案例9 （txt2Excel）</span></div><div>#!/usr/bin/perl -w</div><div>my $ver=&quot;1.0&quot;;</div><div>use strict;</div><div>use Cwd;</div><div>use Getopt::Long;</div><div>use Data::Dumper;</div><div>#use Spreadsheet::WriteExcel;</div><div>use Excel::Writer::XLSX;</div><div>use Encode;</div><div>use FindBin qw($Bin $Script);</div><div>use File::Basename qw(basename dirname);</div><div>my $program=path($0);</div><div>$program=basename$program;</div><div>my (@infile,@cfgfile,@sample,$NULL,$out,$help);</div><div>my $char='\t';</div><div>my $code=&quot;gb2312&quot;;</div><div>my $sheet_code=&quot;utf-8&quot;;</div><div>GetOptions(&quot;i=s{,}&quot;=&gt;\@infile,&quot;n=s{,}&quot;=&gt;\@sample,&quot;header=s{,}&quot;=&gt;\@cfgfile,&quot;null&quot;=&gt;\$NULL,&quot;char=s&quot;=&gt;\$char,</div><div>            &quot;ncode=s&quot;=&gt;\$sheet_code,&quot;code=s&quot;=&gt;\$code,&quot;o=s&quot;=&gt;\$out,&quot;h&quot;=&gt;\$help);</div><div>&amp;help if(!@infile || !$out  || $help);</div><div>###############Time</div><div>my $Time_Start;</div><div>$Time_Start = sub_format_datetime(localtime(time()));</div><div>print &quot;\nStart Time :[$Time_Start]\n\n&quot;;</div><div>##############</div><div>my $xls;</div><div>my $MaxRow=65536;my $MaxLine=256;</div><div>if ($out=~m/xlsx$/) {</div><div>    $MaxRow=1048576;$MaxLine=16384;</div><div>    $xls=Excel::Writer::XLSX-&gt;new($out);</div><div>#    $xls-&gt;set_optimization();</div><div>}else{</div><div>    $xls=Spreadsheet::WriteExcel-&gt;new($out);</div><div>}</div><div><br/></div><div>my $f1 = $xls-&gt;add_format(); # header add a format</div><div>$f1-&gt;set_font('Times New Roman');</div><div>$f1-&gt;set_bold();</div><div>$f1-&gt;set_size('9');</div><div>$f1-&gt;set_align('center');#</div><div>my $f2 = $xls-&gt;add_format();</div><div>$f2-&gt;set_font('Times New Roman');</div><div>#$cellformat-&gt;set_bold();</div><div>$f2-&gt;set_size('9');</div><div>$f2-&gt;set_align('center');</div><div><br/></div><div>my %header;</div><div>if (@cfgfile&gt;0) {</div><div>    my $n=0;</div><div>    foreach my $cfgfile (@cfgfile) {</div><div>        $n++;</div><div>        next if($cfgfile eq &quot;NA&quot;);</div><div>        my $code_tmp=`readlink -f $cfgfile`;chomp$code_tmp;</div><div>        $code_tmp=`file $code_tmp`;</div><div>        $code=&quot;utf-8&quot; if($code_tmp=~m/utf-8/i);</div><div>        print &quot;$cfgfile $code\n&quot;;</div><div>        open IN,$cfgfile || die $!;</div><div>        while (&lt;IN&gt;) {</div><div>            $_=decode(&quot;$code&quot;,$_);</div><div>            chomp;</div><div>            next if(/^$/);</div><div>            my @info=split/$char/,$_;</div><div>#            print Dumper @info;die;</div><div>            push @{$header{$n}},@info;</div><div>        }</div><div>        close IN;</div><div>    }</div><div>}</div><div>my @files;</div><div>foreach my $file (@infile) {</div><div>    if (-d $file) {</div><div>        my @tmpf=glob(&quot;$file/*&quot;);</div><div>        push @files,@tmpf;</div><div>    }else{</div><div>        push @files,$file;</div><div>    }</div><div>}</div><div>for (my $i=1;$i&lt;=@files ;$i++) {</div><div>    $code=&quot;gb2312&quot;;</div><div>    my $max_line=0;</div><div>    my $infile=path($files[$i-1]);</div><div>    my $code_tmp=`readlink -f $infile`;chomp$code_tmp;</div><div>    $code_tmp=`file $code_tmp`;</div><div>    $code=&quot;utf-8&quot; if($code_tmp=~m/utf-8/i);</div><div><br/></div><div>    my ($sheet1,@header);</div><div>    open IN,$infile || die $!;</div><div>    if (!exists $header{$i}){</div><div>        my $header=&lt;IN&gt;;</div><div>        $header=decode($code,$header);</div><div>        #print &quot;$header\n&quot;;</div><div>        @header=split/$char/,$header;</div><div>    }else{</div><div>        @header=@{$header{$i}};</div><div>    }</div><div>    my $name=&quot;sheet$i&quot;;my $row=0;my $line=0;</div><div>    $name=$sample[$i-1] if($sample[$i-1] &amp;&amp; $sample[0] ne &quot;FN&quot;);</div><div>    if(@sample &gt;0 &amp;&amp; $sample[0] eq &quot;FN&quot;){</div><div>        $name=basename$infile ;</div><div>        $name=~s/\.\S+$//;</div><div>    }</div><div>    $name=substr($name,0,31) if(length$name &gt; 31);</div><div>    print &quot;$infile\t$name\t$code\n&quot;;</div><div>    $sheet1 = $xls-&gt;add_worksheet(decode(&quot;$sheet_code&quot;,$name));</div><div>    $sheet1-&gt;write($row,0,\@header,$f1);</div><div>    my $Snum=0;</div><div>    while (my $info=&lt;IN&gt;) {</div><div>        $info=decode(&quot;$code&quot;,$info);</div><div>        chomp$info;</div><div>        next if($info=~/^$/);</div><div>        my @info=split/$char/,$info;</div><div>        if (defined $NULL) {</div><div>            map {delete $info[$_] if($info[$_] &amp;&amp; $info[$_] =~ /^NA$|^NULL$/i);}0..@info-1;</div><div>        }</div><div>        $row++;</div><div>        $max_line=@info if(@info&gt;$max_line);</div><div>        if ($max_line&gt;$MaxLine) {</div><div>            print &quot;warning:Line more than maxinum columns.The file maybe error.&quot;;</div><div>        }</div><div>        $sheet1-&gt;write($row,0,\@info,$f2);</div><div>        if ($row==$MaxRow) {</div><div>            $max_line--;</div><div>            $sheet1-&gt;freeze_panes(1,0);</div><div>            $sheet1-&gt;autofilter(0,0,$row,$max_line);</div><div>            $sheet1-&gt;set_column(0,$max_line,10);</div><div>            $row=0;</div><div>            $Snum++;</div><div>            $max_line=0;</div><div>            $sheet1 = $xls-&gt;add_worksheet(&quot;$name S$Snum&quot;);</div><div>            $sheet1-&gt;write($row,0,\@header,$f1);</div><div>            print &quot;Row more than maxinum rows,auto-add sheet \&quot;$name S$Snum\&quot;.\n&quot;;</div><div>        }</div><div>    }</div><div>    close IN;</div><div>    $max_line--;</div><div>    if($row&gt;1){</div><div>        $sheet1-&gt;freeze_panes(1,0);</div><div>        $sheet1-&gt;autofilter(0,0,$row,$max_line) ;</div><div>        $sheet1-&gt;set_column(0,$max_line,10);</div><div>    }</div><div>}</div><div><br/></div><div>$xls-&gt;close();</div><div>###############Time</div><div>my $Time_End;</div><div>$Time_End = sub_format_datetime(localtime(time()));</div><div>print &quot;\nEnd Time :[$Time_End]\n\n&quot;;</div><div><br/></div><div>###############Subs</div><div>sub sub_format_datetime{#Time calculation subroutine</div><div>    my($sec, $min, $hour, $day, $mon, $year, $wday, $yday, $isdst) = @_;</div><div>    $wday = $yday = $isdst = 0;</div><div>    sprintf(&quot;%4d-%02d-%02d %02d:%02d:%02d&quot;, $year+1900, $mon+1, $day, $hour, $min, $sec);</div><div>}</div><div><br/></div><div>sub path{ #$pavfile=&amp;ABSOLUTE_DIR($pavfile);</div><div>    my $cur_dir=`pwd`;chomp($cur_dir);</div><div>    my ($in)=@_;</div><div>    my $return;</div><div>    if(-f $in){</div><div>        my $dir=dirname($in);</div><div>        my $file=basename($in);</div><div>        chdir $dir;$dir=`pwd`;chomp $dir;</div><div>        $return=&quot;$dir/$file&quot;;</div><div>    }elsif(-d $in){</div><div>        chdir $in;$return=`pwd`;chomp $return;</div><div>    }else{</div><div>        warn &quot;Warning just for file and dir\n&quot;;</div><div>        exit;</div><div>    }</div><div>    chdir $cur_dir;</div><div>    return $return;</div><div>}</div><div><br/></div><div>sub help{</div><div>    print &lt;&lt;&quot;    Usage End.&quot;;</div><div><br/></div><div>    Version: $ver  2016-3-21 update:Automatic identification of file encoding</div><div>    Author : heh (hehua0226\@<a href="http://163.com/">163.com</a>)</div><div><br/></div><div>    Function:Convert text table to excel.The file produced is compatible with Excel 97-2007.</div><div>             Excel2007(xlsx) compared 2003(xls) requires more memory and time.More than</div><div>             maximum number of row automatically increase sheet number.</div><div><br/></div><div>    Usage:</div><div>        perl $program  -i input.txt -o output.xls/output.xlsx [-char \\\\s+ -n input -header header.txt]</div><div>        -i       input files or directory</div><div>        -char    separator,default:$char</div><div>        -code    input files encoding type,default:$code for ANSI;</div><div>                 if it is utf-8,use utf-8.</div><div>        -n       sheet name,default:sheet1 sheet2 ...,</div><div>                 If defined as FN, use the file name(eg: in1.xx.fa is in1 )</div><div>        -ncode   sheet name use chinese,your putty\'s encoding type,default:$sheet_code(gb2312 for ANSI);</div><div>        -header  input header file,must use tab or different row</div><div>                 (default input file first row)</div><div>        -null    convert NA or NULL to empty</div><div>        -o       output file</div><div>    </div><div>        Description                          Limit(2003xls)  Limit(2007xlsx)</div><div>        -----------------------------------  --------------  ---------------</div><div>        Maximum number of chars in a string    32,767          32,767</div><div>        Maximum number of columns              256             16,384</div><div>        Maximum number of rows                 65,536          1,048,576</div><div>        Maximum chars in a sheet name          31              31</div><div>        Maximum chars in a header/footer       254             254</div><div>        Maximum characters in hyperlink        unknown         255</div><div>        Maximum number of unique hyperlinks*   unknown         65,530</div><div><br/></div><div>    Usage End.</div><div>    exit;</div><div>}</div></span>
</div></body></html> 