<html>
<head>
  <title>perl 编程案例7 （我的模块）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="411"/>
<h1>perl 编程案例7 （我的模块）</h1>

<div>
<span><div><span style="font-size: 18.6667px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(255, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">perl 编程案例7 （我的模块）</span></div><div>package exon;</div><div>{</div><div>    $Path::exon::VERSION = '0.1';</div><div>};</div><div>#!/usr/bin/perl -w</div><div>use strict;</div><div>use Cwd;</div><div>use Getopt::Long;</div><div>use Data::Dumper;</div><div>use FindBin qw($Bin $Script);</div><div>use File::Basename qw(basename dirname);</div><div>use JSON;</div><div><br/></div><div>my $abs_path=dirname(__FILE__);</div><div><br/></div><div>my %parameters;</div><div>my $file=&quot;$abs_path/../../db/Z_lzw_database/CONFIG_ALL.txt&quot;;</div><div>initialize($file,\%parameters);</div><div><br/></div><div><br/></div><div>my $samtools=&quot;$parameters{T2}/samtools&quot;;    #######edit by wang 20180327</div><div>my $bedtools=&quot;$parameters{T2}/bedtools&quot;;    #######edit by wang 20180327</div><div><br/></div><div>###############################################################################################</div><div>#</div><div>#以下是注释部分</div><div>#</div><div>###############################################################################################</div><div>sub convert_addinfo2json{</div><div>    my($info)=@_;</div><div>    my %hash;</div><div>    my @result=split /\=/,$info;</div><div>    my ($key,$value);</div><div>    foreach my $i (0..@result-1)</div><div>    {</div><div>        my @tmp=split /\;/,$result[$i];</div><div>        if ($i == @result-1)</div><div>        {</div><div>            $value=join &quot;;&quot;,@tmp if(@tmp&gt;0);</div><div>            if(defined $key)</div><div>            {</div><div>                $value=~s/;$//g;</div><div>                $hash{$key}=$value;</div><div>            };</div><div>        }else</div><div>        {</div><div>            my $tmp=pop @tmp;</div><div>            $value=join &quot;;&quot;,@tmp if(@tmp&gt;0);</div><div>            if(defined $key)</div><div>            {</div><div>                $value=~s/;$//g;</div><div>                $hash{$key}=$value;        </div><div>            };</div><div>            $key=$tmp;</div><div>            $key=lc($key);</div><div>        };</div><div>    };</div><div>    my $last=&amp;json_dumps(\%hash);</div><div>    return $last;</div><div>}</div><div><br/></div><div>sub json_dumps{</div><div>    my ($hash) = @_;</div><div>    my $json = encode_json($hash);</div><div>    return $json;</div><div>}</div><div><br/></div><div>sub json_loads{</div><div>    my ($json) = @_;</div><div>    my $text = decode_json($json);</div><div>    return %{$text};</div><div>}</div><div>###############################################################################################</div><div>sub revise_xgx</div><div>{</div><div>    my @RESULT=@_;</div><div>    for (my $i=0;$i&lt;@RESULT; $i++)</div><div>    {</div><div>        $RESULT[$i]=~s/PA1\+|PA1\：|\：PA1|\:PA1|PA\:|PA//g;</div><div>        $RESULT[$i]=~s/PS5/PS/g;</div><div>        $RESULT[$i]=~s/PM7|PM8/PM/g;</div><div>        $RESULT[$i]=~s/BP8/BP/g;</div><div>        if ($RESULT[$i]=~/^$/)</div><div>        {</div><div>                $RESULT[$i]=&quot;NA&quot;;</div><div>        }elsif($RESULT[$i]=~/\:$|\：$/)</div><div>        {</div><div>                $RESULT[$i]=~s/\:$|\：$//g;</div><div>        };</div><div>    };</div><div>    return @RESULT;</div><div>};</div><div><br/></div><div>#####################</div><div>sub get_handle</div><div>{</div><div>        my($handlefile,$pro,$raw_yuanxu,$sample_name,$out_file)=@_;</div><div><br/></div><div>        my $jiaxihao=&quot;xxxxxxxxxxxx&quot;;</div><div>        open H,&quot;$handlefile&quot; or die &quot;error:cannot open file $handlefile!!!\n&quot;;</div><div>        while(my $A=&lt;H&gt;)</div><div>        {</div><div>            chomp $A;</div><div>            next if($A=~/^$/ || $A=~/^\#/);</div><div>            my @arr=split/\t/,$A;</div><div>            if(!$arr[3] || $arr[3]=~/err/i || $arr[3]=~/NA/i)</div><div>            {</div><div>                </div><div>            }else</div><div>            {</div><div>                if($sample_name=~/^$arr[0]/ &amp;&amp; ($pro eq $arr[5]))</div><div>                {</div><div>                    if(length($arr[0])&gt;=11 || $arr[0]=~/[A-Z]+/)</div><div>                    {</div><div>                        $jiaxihao=$arr[3];</div><div>                    }else</div><div>                    {</div><div>                        chop $arr[3];</div><div>                        $jiaxihao=$arr[3];</div><div><br/></div><div>                    };</div><div>                };</div><div>            };</div><div>        };</div><div>        close H;</div><div>        #####################</div><div>        open H1,&quot;$handlefile&quot; or die &quot;error:cannot open file $handlefile !!!\n&quot;;</div><div>        open OH,&quot;&gt;$out_file&quot; or die &quot;error:cannot write to file $out_file !!!\n&quot;;</div><div>        while(my $B=&lt;H1&gt;)</div><div>        {</div><div>            chomp $B;</div><div>            next if($B=~/^$/ || $B=~/^\#/);</div><div>            my @arrb=split/\t/,$B;</div><div>            my $jiaxi;</div><div>            if(!$arrb[3] || $arrb[3]=~/err/i || $arrb[3]=~/NA/i)</div><div>            {</div><div><br/></div><div>            }else</div><div>            {</div><div>                if(length($arrb[0])&gt;=11 || $arrb[0]=~/[A-Z]+/)</div><div>                {</div><div><br/></div><div>                    $jiaxi=$arrb[3];</div><div>                }else</div><div>                {</div><div>                    $jiaxi=$arrb[3];</div><div>                    chop $jiaxi;</div><div>                };</div><div>                if(($jiaxi eq $jiaxihao) &amp;&amp; ($arrb[5] eq $pro))</div><div>                {</div><div>                    if (!defined $raw_yuanxu || $raw_yuanxu=~/^$/)</div><div>                    {</div><div>                        #$raw_yuanxu=&quot;$arrb[0]&quot;;</div><div>                        $raw_yuanxu=&quot;Not_in_allraw&quot;;</div><div>                    };</div><div>                    chomp $raw_yuanxu;</div><div>                    $raw_yuanxu=~s/B$/A/;</div><div>                    my $value=join&quot;\t&quot;,@arrb[1..@arrb-1];</div><div>                    print OH &quot;$raw_yuanxu\t$value\n&quot;;</div><div>                };</div><div>            };</div><div>        };</div><div>        close H1;</div><div>        close OH;</div><div>    `mv $out_file $out_file\.bak &amp;&amp; sort -u $out_file\.bak &gt;$out_file`;</div><div>};</div><div>##########################################################################</div><div>sub path</div><div>{</div><div>    my ($dir)=@_;</div><div>    $dir=`readlink -f $dir`;</div><div>    chomp $dir;</div><div>    return $dir;</div><div>};</div><div>##########################################################################</div><div>sub NC2chr</div><div>{</div><div>    my $chr=(split /0{4,5}|\./,$_[0])[1];</div><div>    if ($chr eq '23')</div><div>    {</div><div>        $chr='X';</div><div>    }elsif($chr eq '24')</div><div>    {</div><div>        $chr='Y'</div><div>    };</div><div>    return &quot;chr$chr&quot;;</div><div>};</div><div>##########################################################################</div><div>sub get_uniq</div><div>{</div><div>    my @TMP=@_;</div><div>    my (%uniq,@tmp);</div><div>    foreach my $A (@TMP)</div><div>    {</div><div>        next if(!defined $A || $A=~/^$/);</div><div>        if (not exists $uniq{$A})</div><div>        {</div><div>            push @tmp,$A;</div><div>            $uniq{$A}=1;</div><div>        };</div><div>    };</div><div>    return @tmp;</div><div>};</div><div>################################################################################</div><div>sub get_sum</div><div>{</div><div>    my $tot=0;</div><div>    foreach my $A (@_)</div><div>    {</div><div>        $tot+=$A if($A=~/\d+/);</div><div>    };</div><div>    return $tot;</div><div>};</div><div>##########################################################</div><div>sub initialize</div><div>{</div><div>    my ($file,$hash)=@_;</div><div>    open K,&quot;$file&quot; or die &quot;\n\tcan not open file: $file !!!\n\n&quot;; #######   0.读取所有配置文件与参数信息</div><div>    while (&lt;K&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if (/^$/ || /^\#/);</div><div>        my @arr=split /\t+/,$_;</div><div>        if (!defined $arr[2])</div><div>        {</div><div>            $hash-&gt;{$arr[0]}=$arr[1];</div><div>        }else</div><div>        {</div><div>            $arr[2]=~s/\#//g;</div><div>            $hash-&gt;{$arr[0]}=&quot;$arr[1] $arr[2]&quot;;</div><div>        };</div><div>    };</div><div>    close K;</div><div>};</div><div>####################################################################</div><div>sub sh_recheck</div><div>{</div><div>    my($sh,$sh_name,$time)=@_;</div><div>    chomp $sh;</div><div>    if (!defined $time)</div><div>    {</div><div>        $time=2000;</div><div>    };</div><div>    my $return=&quot;\nlook_dog=0;\nwhile \(\(\$look_dog &lt; $time\)\)\ndo\n&quot;;</div><div>    $return.=&quot;\t&quot;.$sh.&quot;\n&quot;;</div><div>    $return.=&quot;\tif [ \$\? == 0 ]\n\t\tthen echo \&quot;\$\? : &quot;.$sh_name.&quot; complete ! &quot;.&quot;\&quot;\n\t\tbreak\n\telse\n\t\techo \&quot;\$\? : &quot;.&quot;$sh_name&quot;.&quot; work error ! &quot;.&quot;\&quot;\n\t\tsleep 10m \n\t\tlook_dog=\$((\$look_dog+600))\n\tfi\ndone\n\n&quot;;</div><div>    return $return;</div><div>};</div><div>####################################################################</div><div>sub file_recheck</div><div>{</div><div>    my($file_name)=@_;</div><div><br/></div><div>    my $return=&quot;\nfile_stat=\$\(file $file_name\)\necho \&quot;$file_name : \$file_stat\&quot;\nif [[ \$file_stat =~ \&quot;No such file or directory\&quot; ]]\n\tthen echo \&quot;error:no file $file_name\&quot;\n\texit\nelif [[ \$file_stat =~ \&quot;empty\&quot; ]]\n\tthen echo \&quot;error:$file_name is empty\&quot;\n\texit\nelse\n\techo \&quot;OK $file_name is not empty\&quot;\nfi\n\n&quot;;</div><div>    return $return;</div><div>};</div><div>####################################################################</div><div>sub file_wait</div><div>{</div><div>    my($file_name,$time)=@_;</div><div>    if (!defined $time)</div><div>    {</div><div>        $time=2000;</div><div>    };</div><div>    my $return=&quot;\nlook_dog=0;\nwhile \(\(\$look_dog &lt; $time\)\)\ndo\n\tif [ -f \&quot;$file_name\&quot; ]\n\t\tthen echo \&quot;$file_name is ok, please go on !!!\&quot;\n\t\tbreak\n\telse\n\t\techo \&quot;sleeping:$file_name is not exists !!!\&quot;\n\t\tsleep 120\n\t\tlook_dog=\$((\$look_dog+120))\n\tfi\ndone\n\n&quot;;</div><div>    return $return;</div><div>};</div><div>###############################################################</div><div>sub dir_bak</div><div>{</div><div>    my ($dir)=@_;</div><div>    my $return=&quot;\ntime=\$\(date\|sed \'s\/ \/\\_\/g\'\) \nif [ -d \&quot;$dir\&quot; ] \n\tthen mv $dir $dir\.bak.\$time\n\tmkdir -p $dir\nelse\n\tmkdir -p $dir\nfi \n\n&quot;;</div><div>    return $return;</div><div>};</div><div>###########################</div><div>sub field_match</div><div>{</div><div>    my($file,$tag,$match)=@_;</div><div>    my $return=&quot;\n\nif [[ \`less $file\|grep \^$tag\` =~ \&quot;$match\&quot; ]]\n\tthen echo \&quot;error:$tag and $match in $file !!!\&quot;\n\texit\nelse\n\techo \&quot;$tag is ok in $file\&quot;\nfi\n\n&quot;;</div><div>    return $return;</div><div>};</div><div>################################################################</div><div>sub dir_sge_check            #######edit by wang 20180327</div><div>{</div><div>    my @sample_dir=@_;</div><div>    my %sge;</div><div>    my %cluster;</div><div>    my $sge_only=&quot;yes&quot;;</div><div>    foreach my $tmp_dir (@sample_dir)</div><div>    {</div><div>        if($tmp_dir=~/share\/(.*?)\//)</div><div>        {</div><div>            my $data_root_dir=$1;</div><div>            if($data_root_dir=~/chigene/)</div><div>            {</div><div>                $cluster{chigene}=1</div><div>            }elsif($data_root_dir=~/ofs/)</div><div>            {</div><div>                $cluster{ofs}=1;</div><div>            }elsif($data_root_dir=~/chg2fs/)</div><div>            {</div><div>                $cluster{chg2fs}=1;</div><div>            };</div><div>        };</div><div>    };</div><div>    </div><div>    if((keys %cluster)&gt;1)</div><div>    {</div><div>        return &quot;no&quot;;</div><div>    }else</div><div>    {</div><div>        foreach my $tmp_dir (@sample_dir)</div><div>        {</div><div>            my $real_sge;</div><div>            if($tmp_dir=~/share\/(.*?)\//)</div><div>            {</div><div>                my $data_root_dir=$1;</div><div>                if (not exists $parameters{$data_root_dir})</div><div>                {</div><div>                    print STDERR &quot;error:can not find data in which sge !!!$tmp_dir\n\n&quot;;</div><div>                    $sge_only=&quot;no&quot;;</div><div>                    last;</div><div>                };</div><div>                $real_sge=$parameters{$data_root_dir};</div><div>            }else</div><div>            {</div><div>                $real_sge=&quot;error&quot;;</div><div>            };</div><div>            $sge{$real_sge}=1;</div><div>        };</div><div>        if((keys %sge)&gt;1)</div><div>        {</div><div>            $sge_only=&quot;no&quot;;</div><div>        };</div><div>        return $sge_only;</div><div>    };</div><div>};</div><div>################################################################</div><div>sub get_dir_work_node</div><div>{</div><div>    my ($sample_dir)=@_;</div><div>    if($sample_dir=~/share\/(.*?)\//)</div><div>    {</div><div>        my $data_root_dir=$1;</div><div>        if ((not exists $parameters{$data_root_dir}) || (not exists $parameters{$parameters{$data_root_dir}}))</div><div>        {</div><div>            print STDERR &quot;error:can not get dir work node!!!$sample_dir:$data_root_dir\n\n&quot;;</div><div>            #die;</div><div>            $sample_dir=$parameters{sge_all}; ##edit by wang 20180327</div><div>        }else</div><div>        {</div><div>            $sample_dir = $parameters{$parameters{$data_root_dir}};</div><div>        };</div><div>    }else</div><div>    {</div><div>        $sample_dir=&quot;error&quot;;</div><div>    };</div><div>    return $sample_dir;</div><div>};</div><div>#######################</div><div>sub get_protein_predict</div><div>{</div><div>    my ($score,$res)=@_;</div><div>    my $return;</div><div>    my @score=split /\;/,$score;</div><div>    my @tag=split /\;/,$res;</div><div>    for (my $i=0;$i&lt; @score;$i++)</div><div>    {</div><div>        if ($score[$i]=~/\d+/ &amp;&amp; $tag[$i]=~/[A-Z]/)</div><div>        {</div><div>            $return=$tag[$i].&quot;(&quot;.$score[$i].&quot;)&quot;;</div><div>            return $return;</div><div>            last;</div><div>        };</div><div>    };</div><div>    return &quot;NA&quot;;</div><div>};</div><div>######################################################</div><div>sub xgx_trans        ##########相关性说明</div><div>{</div><div>    my($origin_xgx,$acmg_path_yiju,$translation)=@_;</div><div><br/></div><div>    my $xgx;</div><div>    if ($acmg_path_yiju=~/$translation-&gt;{acmg_PA}/)</div><div>    {</div><div>        $xgx.=$translation-&gt;{xgx_sm_1};</div><div>    }elsif($acmg_path_yiju=~/\_gain|\_loss|\_upd|\_UPD|\_SMN1|\_wild|\_CNV/)</div><div>    {</div><div>        $xgx=$origin_xgx;</div><div>    }elsif($acmg_path_yiju=~/PVS1/)</div><div>    {</div><div>        if ($acmg_path_yiju=~/PVS1a/)</div><div>        {</div><div>            $xgx.=&quot;;&quot;.$translation-&gt;{xgx_sm_2};</div><div>        }elsif($acmg_path_yiju=~/PVS1c/)</div><div>        {</div><div>            $xgx.=&quot;;&quot;.$translation-&gt;{xgx_sm_3};</div><div>        }elsif($acmg_path_yiju=~/PVS1d/)</div><div>        {</div><div>            $xgx.=&quot;;&quot;.$translation-&gt;{xgx_sm_4};</div><div>        }elsif($acmg_path_yiju=~/PVS1e/)</div><div>        {</div><div>            $xgx.=&quot;;&quot;.$translation-&gt;{xgx_sm_5};</div><div>        }elsif($acmg_path_yiju=~/PVS1f/)</div><div>        {</div><div>            $xgx.=&quot;;&quot;.$translation-&gt;{xgx_sm_6};</div><div>        }else</div><div>        {</div><div>            print STDERR &quot;error:相关性错误,$acmg_path_yiju\n\n&quot;;</div><div>            die;</div><div>        };</div><div>    }elsif($acmg_path_yiju=~/PM8/)</div><div>    {</div><div>        $xgx.=&quot;;&quot;.$translation-&gt;{xgx_sm_7};</div><div>    };</div><div><br/></div><div>    if ($acmg_path_yiju=~/PS2/)</div><div>    {</div><div>        $xgx.=&quot;;&quot;.$translation-&gt;{xgx_sm_11};</div><div>    };</div><div><br/></div><div>    if ($acmg_path_yiju=~/PS1/)</div><div>    {</div><div>        $xgx.=&quot;;&quot;.$translation-&gt;{xgx_sm_9};</div><div>    }elsif($acmg_path_yiju=~/PP5/)</div><div>    {</div><div>        $xgx.=&quot;;&quot;.$translation-&gt;{xgx_sm_10};</div><div>    };</div><div>    if (!defined $xgx)</div><div>    {</div><div>        $xgx=&quot;NA&quot;;</div><div>    }else</div><div>    {</div><div>        $xgx=~s/;$|^;//g;</div><div>    };</div><div>    #######################</div><div>    $xgx=~s/PA1+|PA1：|PA:|PA//g;</div><div>    $xgx=~s/PS5/PS/g;</div><div>    $xgx=~s/PM7|PM8/PM/g;</div><div>    $xgx=~s/BP8/BP/g;</div><div>    if ($xgx=~/^$/)</div><div>    {</div><div>        $xgx=&quot;NA&quot;;</div><div>    };</div><div>    return $xgx;</div><div>};</div><div>#####################################</div><div>sub get_con_whx</div><div>{</div><div>    my ($predict,$amino,$conservation,$hot_region,$translation,$pre_MS,$con_MS)=@_;</div><div>    </div><div>    my ($sift,$polyphen_hdiv,$polyphen_hvar,$provean,$muttas,$mcap,$revel)=split /\;/,$predict;</div><div>    my $delete=0;</div><div>    my $nature=0;</div><div>    my @soft;</div><div>####($provean,$polyphen_hdiv,$polyphen_hvar,$sift,$muttas,$mcup,$revel)=split /[\|\_]/,$arr[32];</div><div>    if (defined $provean &amp;&amp; $provean=~/D/)</div><div>    {</div><div>        $delete++;</div><div>        push @soft,&quot;Provean&quot;;</div><div>    }elsif(defined $provean &amp;&amp; $provean =~/\d+/)</div><div>    {</div><div>        $nature++;</div><div>    };</div><div>    if ((defined $polyphen_hdiv &amp;&amp; $polyphen_hdiv=~/D/) || (defined $polyphen_hvar &amp;&amp; $polyphen_hvar=~/D/))</div><div>    {</div><div>        $delete++;</div><div>        push @soft,&quot;Polyphen2&quot;;</div><div>    }elsif((defined $polyphen_hdiv &amp;&amp; $polyphen_hdiv=~/\d+/) || (defined $polyphen_hvar &amp;&amp; $polyphen_hvar=~/\d+/))</div><div>    {</div><div>        $nature++;</div><div>    };</div><div>    if (defined $sift &amp;&amp; $sift=~/D/)</div><div>    {</div><div>        $delete++;</div><div>        push @soft,&quot;Sift&quot;;</div><div>    }elsif(defined $sift &amp;&amp; $sift =~/\d+/)</div><div>    {</div><div>        $nature++;</div><div>    };</div><div>    if (defined $muttas &amp;&amp; $muttas=~/^A|D/)</div><div>    {</div><div>        push @soft,&quot;Mutationtaster&quot;;</div><div>        $delete++;</div><div>    }elsif(defined $muttas &amp;&amp; $muttas =~/\d+/)</div><div>    {</div><div>        $nature++;</div><div>    };</div><div>    if (defined $mcap &amp;&amp; $mcap=~/D/)</div><div>    {</div><div>        push @soft,&quot;M-CAP&quot;;</div><div>        $delete++;</div><div>    }elsif(defined $mcap &amp;&amp; $mcap =~/\d+/)</div><div>    {</div><div>        $nature++;</div><div>    };</div><div>    if (defined $revel &amp;&amp; $revel=~/D/)</div><div>    {</div><div>        push @soft,&quot;REVEL&quot;;</div><div>        $delete++;</div><div>    }elsif(defined $revel &amp;&amp; $revel =~/\d+/)</div><div>    {</div><div>        $nature++;</div><div>    };</div><div>    ###########################</div><div>    if ($delete&gt;=2 || ($delete&gt;=1 &amp;&amp; $amino=~/^移码|^frameshift/))</div><div>    {</div><div>        $$pre_MS=$translation-&gt;{construnct_sm_1}.&quot;(&quot;.(join &quot;,&quot;,@soft).&quot;)&quot;;    #######return &quot;deleterious&quot;;</div><div>        $$con_MS=&quot;$amino&quot;.&quot;,&quot;.&quot;$$pre_MS&quot;;</div><div>    }elsif($nature&gt;=2)</div><div>    {</div><div>        $$pre_MS=$translation-&gt;{construnct_sm_2};        ##############return &quot;neutral&quot;;</div><div>        $$con_MS=&quot;$amino&quot;.&quot;,&quot;.&quot;$$pre_MS&quot;;</div><div>    }else</div><div>    {</div><div>        $$con_MS=&quot;$amino&quot;;</div><div>    };</div><div>    if ($conservation=~/Y/ &amp;&amp; $hot_region=~/Y/)</div><div>    {</div><div>        $$con_MS.=&quot;,&quot;.$translation-&gt;{construnct_sm_3};</div><div>    }elsif($conservation=~/Y/)</div><div>    {</div><div>        $$con_MS.=&quot;,&quot;.$translation-&gt;{construnct_sm_4};</div><div>    }elsif($hot_region=~/Y/)</div><div>    {</div><div>        $$con_MS.=&quot;,&quot;.$translation-&gt;{construnct_sm_5};</div><div>    };</div><div>};</div><div>#######################</div><div>sub get_parameters        ##############&amp;get_parameters($model,\%parameters);</div><div>{</div><div>    my ($file,$hash)=@_;</div><div>    open L,&quot;$file&quot; or die &quot;\n\tcan not open file: $file !!!\n\n&quot;;</div><div>    while (&lt;L&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if (/^$/ || /^#/);</div><div>        my ($key,$value)=split /\t+/,$_,2;</div><div>        $hash-&gt;{$key}=$value;</div><div>    };</div><div>    close L;</div><div>};</div><div><br/></div><div>#########################</div><div>sub add_blank</div><div>{</div><div>    my($old,$num)=@_;</div><div>    for(my $i=0;$i&lt;$num;$i++)</div><div>    {</div><div>        push @{$old},&quot;NA&quot;</div><div>    };</div><div>};</div><div>#############################################################</div><div>sub write_out</div><div>{</div><div>    my ($out,$info)=@_;</div><div>    open OUT,&quot;&gt;$out&quot; or die &quot;error:can not open file $out\n\n&quot;;</div><div>    if (!defined $info || $info=~/^$/)</div><div>    {</div><div>        print STDERR &quot;error:$out is error !!!\n&quot;;</div><div>        die;</div><div>    };</div><div>    print OUT &quot;$info&quot;;</div><div>    close OUT;</div><div>};</div><div><br/></div><div>######################################################</div><div>sub read_hash</div><div>{</div><div>    my ($file,$hash,$key,$value,$type)=@_;</div><div>    if (!defined $type)</div><div>    {</div><div>        $type=1;</div><div>    };</div><div>    open L,&quot;$file&quot; or die &quot;\n\tcan not open file: $file !!!\n\n&quot;;</div><div>    while (&lt;L&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if (/^$/ || /^#/);</div><div>        my @arr=split /\t/,$_;</div><div>        #######################</div><div>        my ($VALUE,@VALUE);</div><div>        if ($value eq &quot;0&quot;)</div><div>        {</div><div>            $VALUE=$_;</div><div>        }else</div><div>        {</div><div>            my @value_vols=split /\,/,$value;</div><div>            foreach my $vol (@value_vols)</div><div>            {</div><div>                if($vol &gt;0)</div><div>                {</div><div>                    push @VALUE,$arr[$vol-1];</div><div>                }else</div><div>                {</div><div>                    push @VALUE,$arr[$vol];</div><div>                };</div><div>            };</div><div>            if(!defined $VALUE[0])</div><div>            {</div><div>                print &quot;error:$file !\n&quot;;</div><div>                die;</div><div>            }</div><div>            $VALUE=join &quot;\t&quot;,@VALUE;</div><div>        };</div><div>        if (!defined $VALUE)</div><div>        {</div><div>            print STDERR &quot;\n\tfile error: $file \n\t$_\n\n&quot;;</div><div>            die;</div><div>        };</div><div>        ##########################</div><div>        my @key_vols=split /\,/,$key;</div><div>        if ($type==1)</div><div>        {</div><div>            my ($KEY,@KEY);</div><div>            foreach my $vol (@key_vols)</div><div>            {</div><div>                if($vol &gt;0)</div><div>                {</div><div>                    if (!defined $arr[$vol-1])</div><div>                    {</div><div>                        print STDERR &quot;\n\tfile error: $file\n\t$_\nnum:$key\n$value\n&quot;;</div><div>                        die;</div><div>                    };</div><div>                    push @KEY,$arr[$vol-1];</div><div>                }else</div><div>                {</div><div>                    if (!defined $arr[$vol])</div><div>                    {</div><div>                        print STDERR &quot;\n\tfile error: $file\n\t$_\nnum:$key\n$value\n&quot;;</div><div>                        die;</div><div>                    };</div><div>                    push @KEY,$arr[$vol];</div><div>                };</div><div>            };</div><div>            $KEY=join &quot;\t&quot;,@KEY;</div><div>            if (!defined $KEY)</div><div>            {</div><div>                print Dumper \@KEY;</div><div>                print STDERR &quot;\n\tfile error: $file\n\t$_\nnum:$key\n$value\n&quot;;</div><div>                die;</div><div>            };</div><div>            $hash-&gt;{$KEY}=$VALUE;</div><div>        }elsif($type==2 &amp;&amp; @key_vols==2)</div><div>        {</div><div>            my $tmp_1;</div><div>            my $tmp_2;</div><div>            if($key_vols[0] &gt;0)</div><div>            {</div><div>                $tmp_1=$key_vols[0]-1;</div><div>            }else</div><div>            {</div><div>                $tmp_1=$key_vols[0];</div><div>            };</div><div>            if($key_vols[1] &gt;0)</div><div>            {</div><div>                $tmp_2=$key_vols[1]-1;</div><div>            }else</div><div>            {</div><div>                $tmp_2=$key_vols[1];</div><div>            };</div><div>            </div><div>            if (!defined $arr[$tmp_1] || !defined $arr[$tmp_2])</div><div>            {</div><div>                print STDERR &quot;\n\tfile error: $file \n\t$_\n\n&quot;;</div><div>                die;</div><div>            };</div><div>            $hash-&gt;{$arr[$tmp_1]}{$arr[$tmp_2]}=$VALUE;</div><div>        }elsif($type==3 &amp;&amp; @key_vols==3)</div><div>        {</div><div>            my $tmp_1;</div><div>            my $tmp_2;</div><div>            my $tmp_3;</div><div>            if($key_vols[0] &gt;0)</div><div>            {</div><div>                    $tmp_1=$key_vols[0]-1;</div><div>            }else</div><div>            {</div><div>                    $tmp_1=$key_vols[0];</div><div>            };</div><div>            if($key_vols[1] &gt;0)</div><div>            {</div><div>                    $tmp_2=$key_vols[1]-1;</div><div>            }else</div><div>            {</div><div>                    $tmp_2=$key_vols[1];</div><div>            };</div><div>            if($key_vols[2] &gt;0)</div><div>            {</div><div>                    $tmp_3=$key_vols[2]-1;</div><div>            }else</div><div>            {</div><div>                    $tmp_3=$key_vols[2];</div><div>            };</div><div><br/></div><div>            if (!defined $arr[$tmp_1] || !defined $arr[$tmp_2] || !defined $arr[$tmp_3])</div><div>            {</div><div>                print STDERR &quot;\n\tfile error: $file \n\t$_\n\n&quot;;</div><div>                die;</div><div>            };</div><div>            $hash-&gt;{$arr[$tmp_1]}{$arr[$tmp_2]}{$arr[$tmp_3]}=$VALUE;</div><div>        }else</div><div>        {</div><div>            print STDERR &quot;\n\tfile error: $file \n\t$_\n\n&quot;;</div><div>            die;</div><div>        };</div><div>    };</div><div>    close L;</div><div>};</div><div>###############################################</div><div>sub find_arr_dir</div><div>{</div><div>    my ($dir,$sample,$program)=@_;</div><div>    my @return;</div><div>    if (!defined $program)</div><div>    {</div><div>        $program=&quot;NT&quot;;</div><div>    };</div><div>    foreach my $AA (@{$sample})</div><div>    {</div><div>        if ($AA=~/err/)</div><div>        {</div><div>            push @return,&quot;error_in_$AA&quot;;</div><div>            next;</div><div>        };</div><div>        my $BB=$AA;</div><div>        ($BB)=split /xb|sl|zj|xj|\_|\s+/,$BB;</div><div>        my @tmp_dir=glob &quot;$dir/@{[substr($AA,0,2)]}*/$BB*$program*/&quot;;</div><div>        if(@tmp_dir&lt;1)</div><div>        {</div><div>            push @return,&quot;error_in_$AA&quot;;</div><div>        }else</div><div>        {</div><div>            foreach my $tmp_dir (@tmp_dir)</div><div>            {</div><div>                $tmp_dir=`readlink -f $tmp_dir`;</div><div>                chomp $tmp_dir;</div><div>                push @return,$tmp_dir;</div><div>            };</div><div>        };</div><div>    };</div><div>    return @return;</div><div><br/></div><div>};</div><div>####################</div><div>sub find_var_dir</div><div>{</div><div>    my ($dir,$sample,$program)=@_;</div><div>    if (!defined $sample)</div><div>    {</div><div>        print STDERR &quot;error:$dir\t$sample \n&quot;;</div><div>        die;</div><div>    };</div><div>    if (!defined $program)</div><div>    {</div><div>        $program=&quot;NT01&quot;;</div><div>    };</div><div>    my ($outdir)=glob &quot;$dir/@{[substr($sample,0,2)]}*/$sample*$program*/&quot;;</div><div>    if(!defined $outdir)</div><div>    {</div><div>        return &quot;error&quot;;</div><div>    }else</div><div>    {</div><div>        $outdir=`readlink -f $outdir`;</div><div>        chomp $outdir;</div><div>        return $outdir;</div><div>    };</div><div>};</div><div>################################################</div><div>sub get_outname</div><div>{</div><div>    my ($od,$samples,$relation,$program,$DD_number,$all_raw)=@_;</div><div>    my $name=&quot;$od/$DD_number\_$program\_b&quot;;</div><div><br/></div><div>    for (my $i=0;$i&lt;@{$samples} ;$i++)</div><div>    {</div><div>        my $batch;</div><div>        if (`cut -f 1-4 $all_raw|grep $$samples[$i]|grep F|grep -E 'NT0'|tail -1|cut -f 1`)</div><div>        {</div><div>            $batch=`cut -f 1-4 $all_raw|grep $$samples[$i]|grep F|grep -E 'NT0'|tail -1|cut -f 1`;</div><div>            chomp $batch;</div><div>        }else</div><div>        {</div><div>            $batch=`cut -f 1-4 $all_raw|grep $$samples[$i]|grep -E 'NT0'|tail -1|cut -f 1`;</div><div>            chomp $batch;</div><div>        };</div><div>        if(!defined $batch)</div><div>        {</div><div>            print &quot;error:$$samples[$i]\n$all_raw\n&quot;;</div><div>            die;</div><div>        };</div><div>        $name.=&quot;$batch&quot;.&quot;A&quot;;</div><div>    };</div><div>#    print Dumper \@{$samples};</div><div>#    print Dumper \%{$relation};</div><div><br/></div><div>    if (@{$samples}==3 &amp;&amp; exists $relation-&gt;{son} &amp;&amp; exists $relation-&gt;{father} &amp;&amp; exists $relation-&gt;{mother})</div><div>    {</div><div>        $name.=&quot;_Trios_acmg2.0.xlsx&quot;;</div><div>    }elsif(@{$samples}==3 &amp;&amp; exists $relation-&gt;{daughter} &amp;&amp; exists $relation-&gt;{father} &amp;&amp; exists $relation-&gt;{mother})</div><div>    {</div><div>        $name.=&quot;_Trios_acmg2.0.xlsx&quot;;</div><div>    }else</div><div>    {</div><div>        $name.=&quot;_unTrios_acmg2.0.xlsx&quot;;</div><div>    };</div><div>    my $txt_name=$name;</div><div>    $txt_name=~s/xlsx$/txt/;</div><div>    return ($txt_name,$name);</div><div>};</div><div>###########################################################</div><div>sub get_level</div><div>{</div><div>    my ($ms)=@_;</div><div>    my $return;</div><div>    if ($ms=~/Pathogenic/)</div><div>    {</div><div>        $return=1;</div><div>    }elsif ($ms=~/pathogenic/)</div><div>    {</div><div>        $return=2;</div><div>    }elsif($ms=~/Uncertain/)</div><div>    {</div><div>        $return=3;</div><div>    }elsif ($ms=~/benign/)</div><div>    {</div><div>        $return=4;</div><div>    }elsif ($ms=~/Benign/)</div><div>    {</div><div>        $return=5;</div><div>    }else</div><div>    {</div><div>        $return=&quot;error&quot;;</div><div>    };</div><div>    return $return;</div><div>};</div><div>#############################################################</div><div>sub read_annoation</div><div>{</div><div>    my ($file,$hash,$type)=@_;</div><div>    open L,&quot;$file&quot; or die &quot;\n\tcan not open file: $file !!!\n\n&quot;;</div><div>    $/=&quot;&gt;####&quot;;</div><div>    &lt;L&gt;;</div><div>    while (&lt;L&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if (/^$/ || /^#/);</div><div>        my ($head,$anno)=split /\n/,$_,2;</div><div>        my @arr=split /\t/,$head;</div><div>        my $KEY;</div><div>        if ($type=~/MUTE/)</div><div>        {</div><div>            $KEY=$arr[5];</div><div>        }elsif($type=~/GENE/)</div><div>        {</div><div>            $KEY=$arr[0];</div><div>        }elsif($type=~/AMINO/)</div><div>        {</div><div>            next if($arr[1] eq &quot;NA&quot;);</div><div>            $KEY=&quot;$arr[3]|$arr[0]|$arr[2]|$arr[1]&quot;;</div><div>        }else</div><div>        {</div><div>            print STDERR &quot;type error:$_\n\n&quot;;</div><div>            die;</div><div>        };</div><div>        my $VALUE=$anno;</div><div>        if (!defined $KEY || !defined $VALUE)</div><div>        {</div><div>            print STDERR &quot;infor_error:$file\n\t$_\n&quot;;</div><div>            die;</div><div>        };</div><div>        $hash-&gt;{$KEY}=$VALUE;</div><div>    };</div><div>    $/=&quot;\n&quot;;</div><div>    close L;</div><div>};</div><div>##########################################read total_annoation_yqh_20190211</div><div>sub read_total_annoation{</div><div>        my ($file,$db)=@_;</div><div>        open L,&quot;&lt;$file&quot; or die &quot;Cannot open $file!!!&quot;;</div><div>        my $key;</div><div>        while(&lt;L&gt;){</div><div>                chomp;next if(/^$/);</div><div>                my @line = split(/\t/,$_);</div><div>                if($_ =~ /^NC_/){</div><div>                         $key = $line[-1];</div><div>                }elsif($line[1] =~ /^####/){</div><div>                        my $dbname = shift(@line);</div><div>                        $dbname = shift(@line);</div><div>                        $dbname =~ s/####//g;</div><div>                        my $value = join(&quot;\t&quot;,@line);</div><div>                        $value = &quot;\t$value&quot;;</div><div>                        if(not exists $db-&gt;{$dbname}-&gt;{$key}){</div><div>                                        $db-&gt;{$dbname}-&gt;{$key} = $value;</div><div>                        }else{</div><div>                                        $db-&gt;{$dbname}-&gt;{$key} .= &quot;\n$value&quot;;</div><div>                        }</div><div>                }else{</div><div>                        print STDERR &quot;$_ is wrong format!&quot;;</div><div>                        die;</div><div>                }</div><div>        }</div><div>        close L;</div><div>}</div><div><br/></div><div>##########################################</div><div>sub get_mut_compile</div><div>{</div><div>    my ($mut)=@_;</div><div>    my ($chr,$start,$end,$ref,$alt)=split /\_/,$mut;</div><div>    my @tmp;</div><div>    push @tmp,$chr,$start,$end,$ref,$alt;</div><div>    if ($ref=~/-/)</div><div>    {</div><div>        push @tmp,&quot;D&quot;;</div><div>    }elsif($alt=~/-/)</div><div>    {</div><div>        push @tmp,&quot;D&quot;;</div><div>    }else</div><div>    {</div><div>        push @tmp,&quot;S&quot;;</div><div>    };</div><div>    return @{[join &quot;_&quot;,@tmp]};</div><div>};</div><div><br/></div><div>#######################################</div><div>sub get_base_seq</div><div>{</div><div>    my ($pos,$genenome)=@_;</div><div>    my $seq=`$samtools faidx $genenome $pos|grep -v chr`;</div><div>    $seq=~s/\s+//g;</div><div>    return $seq;</div><div>};</div><div>###############################################################################################</div><div>sub get_effec_num</div><div>{</div><div>    my ($a,$res)=@_;</div><div>    $a=~s/^ | $//g;</div><div>    if ($a=~/^(\d+)\.0+$/)</div><div>    {</div><div>        $res=$1;</div><div>        return $res;</div><div>    }elsif ($a=~/^(\d+\.)(0*)(\d+)$/)</div><div>    {</div><div>        my $bef=$1;</div><div>        my $zero=$2;</div><div>        my $aft=$3;</div><div>        if ($aft==0)</div><div>        {</div><div>            $zero.=0;</div><div>            $aft=&quot;&quot;;</div><div>        };</div><div>        my ($tmptwo,$three);</div><div>        if (length($aft)&gt;=3)</div><div>        {</div><div>            $tmptwo=substr($aft,0,2);</div><div>            $three=substr($aft,2,1);</div><div>            if ($three&gt;=5) {++$tmptwo};</div><div>            if (length $tmptwo&gt;2)</div><div>            {</div><div>                if (defined $zero &amp;&amp; $zero=~/0$/)</div><div>                {</div><div>                    $zero=~s/0$//;</div><div>                    $res=$bef.$zero.$tmptwo;</div><div>                }else</div><div>                {</div><div>                    $bef=&quot;1.&quot;;</div><div>                    $tmptwo=~s/^\d//;</div><div>                    $res=$bef.$zero.$tmptwo;</div><div>                };</div><div>            }else</div><div>            {</div><div>                $res=$bef.$zero.$tmptwo;</div><div>            };</div><div>        }elsif(length($aft)&gt;0)</div><div>        {</div><div>            $tmptwo=$aft;</div><div>            while (length($tmptwo)&lt;2)</div><div>            {</div><div>                $tmptwo.=0;</div><div>            };</div><div>            $res=$bef.$zero.$tmptwo;</div><div>        }else</div><div>        {</div><div>            $res=$bef;</div><div>            $res=~s/\.$//;</div><div>        };</div><div>        while ($res=~/0$|\.$/)</div><div>        {</div><div>            $res=~s/0$|\.$//g;</div><div>        };</div><div>        if ($res=~/^$/)</div><div>        {</div><div>            $res=0;</div><div>        };</div><div>        return $res;</div><div>    }else</div><div>    {</div><div>        $res=$a;</div><div>        return $res;</div><div>    };</div><div>};</div><div>######################################################</div><div>##########################################################################</div><div>sub read_all_raw</div><div>{</div><div>    my($all_raw,$hash)=@_;</div><div>    open L,&quot;$all_raw&quot; or die&quot;error:can not open file $all_raw !!!\n&quot;;</div><div>    while (&lt;L&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if(/^$/);</div><div>        next if($_!~/^\d+/);</div><div>        my ($batch,$sample,$prog,$chip,$sex,$fq,$lib,$info_add)=split /\t/,$_;</div><div>        ##################</div><div>        $hash-&gt;{$sample}{batch}=$batch;</div><div>        $hash-&gt;{$sample}{prog}=$prog;</div><div>        $hash-&gt;{$sample}{chip}=$chip;</div><div>        $hash-&gt;{$sample}{sex}=$sex;</div><div>        $hash-&gt;{$sample}{fq}=$fq;</div><div>        $hash-&gt;{$sample}{lib}=$lib if(defined $lib);</div><div>        $hash-&gt;{$sample}{info_add}=$info_add if(defined $info_add);</div><div>    };</div><div>    close L;</div><div>};</div><div><br/></div><div><br/></div><div>sub get_fam_relative</div><div>{</div><div>    my ($conf_file,$number,$stdout)=@_;</div><div>    my %info;</div><div>    &amp;read_all_raw($conf_file,\%info);</div><div>    ###################</div><div>    my $ID=(split /xb|sl|zj|xj/,$number)[0];</div><div>    my $od=dirname($stdout);</div><div>    my $outfile=&quot;$od/$ID\_origin.txt&quot;;</div><div>    if (exists $info{$number})</div><div>    {</div><div>        if ((exists $info{$number}{chip}) &amp;&amp; $info{$number}{chip}=~/NT/ &amp;&amp; (exists $info{$number}{info_add}))</div><div>        {</div><div>            `wget -O $outfile -P ./ <a href="http://sample.zhiyindongfang.com/sample-app/desktop/sale/SpecialExam/findSpecialExamList.action?taskCode=$info">http://sample.zhiyindongfang.com/sample-app/desktop/sale/SpecialExam/findSpecialExamList.action?taskCode=$info</a>{$number}{info_add}`;</div><div>        }elsif((exists $info{$number}{chip}) &amp;&amp; $info{$number}{chip}=~/NT/ &amp;&amp; (exists $info{$number}{prog}))</div><div>        {</div><div>            `wget -O $outfile -P ./ <a href="http://sample.zhiyindongfang.com/sample-app/desktop/sale/SpecialExam/findSpecialExamList.action?taskCode=$ID">http://sample.zhiyindongfang.com/sample-app/desktop/sale/SpecialExam/findSpecialExamList.action?taskCode=$ID</a>\_$info{$number}{prog}`;</div><div>        }else</div><div>        {</div><div>            print STDERR &quot;$number program maybe error ?\n&quot;;</div><div>            return 0;</div><div>        };</div><div>    }else</div><div>    {</div><div>        print &quot;$number not in ALL_RAW \n&quot;;</div><div>        return 0;</div><div>    };</div><div><br/></div><div>    my $jsfile=&quot;$od/$ID\_json.txt&quot;;</div><div>    &amp;read_js($outfile,$jsfile);</div><div><br/></div><div>    my @springs=split /\n/,`grep -v callName $jsfile`;</div><div><br/></div><div>    open OUT,&quot;&gt;$stdout&quot; or die;</div><div>    my $i=1;</div><div>    foreach (@springs)</div><div>    {</div><div>        chomp $_;</div><div>        my @result;</div><div>        my @arr=split /\t/,$_;</div><div>        my $id=$arr[-1];</div><div>        my $realnumber;</div><div>        if (`cut -f 1-4 $conf_file|grep $id|tail -1|cut -f 1`)</div><div>        {</div><div>            $realnumber=`cut -f 1-4 $conf_file|grep $id|tail -1|cut -f 2`;</div><div>            chomp $realnumber;</div><div>            if ($info{$number}{prog} ne $info{$realnumber}{prog})</div><div>            {</div><div>                print STDERR &quot;$id not the same program ! \n&quot;;</div><div>                next;</div><div>            };</div><div>            push @result,$realnumber,$arr[1];</div><div>        }else</div><div>        {</div><div>            push @result,$id,$arr[1],&quot;error:$id not in ALL_RAW&quot;;</div><div>            print STDERR &quot;$id not in ALL_RAW !\n&quot;;</div><div>            next;</div><div>        };</div><div><br/></div><div>        if ($arr[5]=~/女/)</div><div>        {</div><div>            push @result,'FM';</div><div>        }elsif($arr[5]=~/男/)</div><div>        {</div><div>            push @result,'M';</div><div>        }else</div><div>        {</div><div>            my $two=substr($id,0,2);</div><div>            my $sex_file=(glob &quot;/share/ofs1a/prod/sample/$two*/$id*/4.1_QC/QC_report.txt&quot;)[0];</div><div>            if (!$sex_file || !-f $sex_file)</div><div>            {</div><div>                print STDERR &quot;$id\tno_sex\n&quot;;</div><div>                push @result,'FM';</div><div>#                die;</div><div>            }else</div><div>            {</div><div>                if (`less $sex_file|grep sex` =~/XX/)</div><div>                {</div><div>                    push @result,'FM';</div><div>                }elsif(`less $sex_file|grep sex` =~/XY/)</div><div>                {</div><div>                    push @result,'M';</div><div>                }else</div><div>                {</div><div>                    print STDERR &quot;$id\tno_sex\n&quot;;</div><div>                    die;</div><div>                };</div><div>            };</div><div>        };</div><div>        push @result,$arr[4],$arr[4],$arr[3];</div><div>        </div><div>        my $relate='NA';</div><div>        if (($arr[0] eq '先证者') || ($arr[0] eq 'NA'))</div><div>        {</div><div>            if ($result[2] eq 'M')</div><div>            {</div><div>                push @result,&quot;先证者男&quot;;</div><div>                $relate='son';</div><div>            }else</div><div>            {</div><div>                push @result,&quot;先证者女&quot;;</div><div>                $relate='daughter';</div><div>            };</div><div>        }elsif($arr[0] eq &quot;父&quot;)</div><div>        {</div><div>            push @result,$arr[0].$arr[2];</div><div>            $relate='father';</div><div>        }elsif($arr[0] eq &quot;母&quot;)</div><div>        {</div><div>            push @result,$arr[0].$arr[2];</div><div>            $relate='mother';</div><div>        }else</div><div>        {</div><div>            push @result,&quot;成员$i\-$arr[0]&quot;.$arr[2];</div><div>            $i++;</div><div>            ##################</div><div>            if ($arr[0]=~/兄|弟|姐|妹/)</div><div>            {</div><div>                if($arr[2]=~/患者|轻微表型/)</div><div>                {</div><div>                    if ($result[2] eq 'FM')</div><div>                    {</div><div>                        $relate='daughter';</div><div>                    }elsif($result[2] eq 'M')</div><div>                    {</div><div>                        $relate='son';</div><div>                    };</div><div>                }else</div><div>                {</div><div>                    $relate='other';</div><div>                };</div><div>            }else</div><div>            {</div><div>                $relate='other';</div><div>            };</div><div>        };</div><div>        push @result,$arr[1];</div><div><br/></div><div>        if ($arr[2]=~/患者/)</div><div>        {</div><div>            push @result,&quot;患者&quot;,&quot;4&quot;;</div><div>        }elsif($arr[2]=~/轻微表型/)</div><div>        {</div><div>            push @result,&quot;轻微表型&quot;,&quot;2&quot;;</div><div>        }elsif($arr[2]=~/正常/)</div><div>        {</div><div>            push @result,&quot;正常&quot;,&quot;0&quot;;</div><div>        }elsif($arr[2]=~/其它表型/)</div><div>        {</div><div>            push @result,&quot;正常&quot;,&quot;0&quot;;</div><div>        };</div><div>        push @result,$relate;</div><div><br/></div><div>        my $res=join &quot;\t&quot;,@result;</div><div>        print OUT &quot;$res\n&quot;;</div><div>    };</div><div>    close OUT;</div><div>};</div><div>#########################################</div><div>#########################################</div><div>sub read_js</div><div>{</div><div>    my($js_file,$outfile)=@_;</div><div>    #################</div><div>    my $js;</div><div>    open L,&quot;$js_file&quot; or die &quot;\n\t:no_file:$js_file\n&quot;;</div><div>    while(&lt;L&gt;)</div><div>    {</div><div>        $js .= &quot;$_&quot;;</div><div>    };</div><div>    close L;</div><div>    #################</div><div>    open OUT,&quot;&gt;$outfile&quot; or die;</div><div>    my $obj = new JSON -&gt;decode($js);</div><div>    my @head=(&quot;callName&quot;,&quot;checkerName&quot;,&quot;disease_condition&quot;,&quot;examCode&quot;,&quot;family_code&quot;,&quot;gender&quot;,&quot;member_sequence&quot;,&quot;report_code&quot;,&quot;resource_code&quot;);</div><div>    print OUT (join &quot;\t&quot;,@head),&quot;\n&quot;;</div><div>    foreach my $key1 (sort keys %{$obj})</div><div>    {</div><div>        next if (ref($obj-&gt;{$key1}) ne &quot;ARRAY&quot;);</div><div>        for(my $num=0; $num&lt;@{$obj-&gt;{$key1}}; $num++)###(0..@{$obj-&gt;{$key1}})</div><div>        {</div><div>            if ((ref($obj-&gt;{$key1}[$num]) eq 'HASH'))</div><div>            {</div><div>                foreach my $key2 (@head)</div><div>                {</div><div>                    if(not exists $obj-&gt;{$key1}[$num]{$key2})</div><div>                    {</div><div>                        $obj-&gt;{$key1}[$num]{$key2}=&quot;NA&quot;;</div><div>                    };</div><div>                    print OUT &quot;$obj-&gt;{$key1}[$num]{$key2}\t&quot;;</div><div>                };</div><div>            };</div><div>            print OUT &quot;\n&quot;;</div><div>        };</div><div>    };</div><div>    close OUT;</div><div>};</div><div>##########################################################################</div><div><br/></div><div>###############################################################################################</div><div>#</div><div>#以下是统计部分</div><div>#</div><div>###############################################################################################</div><div>sub get_gene_cov_dep</div><div>{</div><div>    my ($cov_dep_file,$hash,%result)=@_;</div><div>    open L,&quot;$cov_dep_file&quot; or die&quot;$!&quot;;</div><div>    while(&lt;L&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if /^$/;</div><div>        my @array=split;</div><div>        my $gene=$array[4];</div><div>        next if (!$gene);</div><div>        $result{$gene}{'cover_length'}+=(split /\//,$array[-2])[0];</div><div>        $result{$gene}{'length'}+=(split /\//,$array[-2])[1];</div><div>        $result{$gene}{'depth'}+=(split /\//,$array[-4])[0];</div><div>    };</div><div>    close L;</div><div>    foreach my $A(keys %result)</div><div>    {</div><div>        my $coverage=$result{$A}{'cover_length'}/$result{$A}{'length'};</div><div>        my $average=$result{$A}{'depth'}/$result{$A}{'length'};</div><div>        $hash-&gt;{$A}=&quot;$coverage\t$average&quot;;</div><div>    };</div><div>};</div><div>###############################################################################################</div><div>sub get_nX_ratio    #######&amp;exon::get_gene_10X_cov($bed_depth,\%gene_bed,\%cov_dep,\%genecov_10X);</div><div>{</div><div>    my ($gene,$depth,$out,$hash)=@_;</div><div>    my($totlen,$totdepth,%totpoint);</div><div>    open L,&quot;$depth&quot; or die;</div><div>    open M,&quot;&gt; $out\.tmp1.bed&quot; or die;</div><div>    while (my $DEPTH=&lt;L&gt;)</div><div>    {</div><div>        chomp $DEPTH;</div><div>        next if ($DEPTH=~/^$/);</div><div>        my @array=split /\t/,$DEPTH;</div><div>        my $start=$array[1]-1;</div><div>        print M &quot;$array[0]\t$start\t$array[1]\t$array[2]\n&quot;;</div><div>    };</div><div>    close L;</div><div>    close M;</div><div>    ############################################</div><div>    open N,&quot;$gene&quot; or die;</div><div>    open Z,&quot;&gt; $out\.tmp2.bed&quot; or die;</div><div>    while (&lt;N&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if (/^$/);</div><div>        my @arr=split /\t/,$_;</div><div>        $totlen+=$arr[2]-$arr[1];</div><div>        print Z &quot;$arr[0]\t$arr[1]\t$arr[2]\n&quot;;</div><div>    };</div><div>    close N;</div><div>    close Z;</div><div>    `bedtools window -a $out\.tmp2.bed -b $out\.tmp1.bed -w 0 &gt;$out\.tmp.result.bed`;</div><div>    ###############################################</div><div>    open K,&quot;$out\.tmp.result.bed&quot; or die;</div><div>    while (&lt;K&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if (/^$/);</div><div>        my @arr=split /\t/,$_;</div><div>        ++$totpoint{$arr[6]};</div><div>        $totdepth+=$arr[6];</div><div>    };</div><div>    close K;</div><div>    foreach my $num (1,2,5,10,20,30)</div><div>    {</div><div>        my $point=0;</div><div>        foreach my $dep (sort {$b &lt;=&gt; $a} keys %totpoint)</div><div>        {</div><div>            last if ($dep&lt;$num);</div><div>            $point+=$totpoint{$dep};</div><div>        };</div><div>        $hash-&gt;{$num}=$point/$totlen;</div><div>    };</div><div>    $hash-&gt;{ave}=$totdepth/$totlen;</div><div>    `rm $out\.tmp*`;</div><div>};</div><div>###################################################################################</div><div>###############################################################################################</div><div>sub get_UPD</div><div>{</div><div>    my ($infile,$outfile)=@_;</div><div>    my ($filter_dep,$filter_rat,$homo,%depth,%uniq,%chr_cnv)=(10,0.3,0.85);</div><div>    ############################################</div><div>    my $chrcnv=$infile;</div><div>    $chrcnv=~s/3.3_variation_annotation\/tot_5_level.report.txt/5.2_EXON_deletion\/chr_cnv.txt/;</div><div>    open K,&quot;$chrcnv&quot; or die;</div><div>    &lt;K&gt;;</div><div>    while (&lt;K&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if (/^$/);</div><div>        my @arr=split /\t/,$_;</div><div>        $chr_cnv{$arr[0]}=$arr[-1];</div><div>    };</div><div>    close K;</div><div>    #############################</div><div>    my $sexQC=$infile;</div><div>    $sexQC=~s/3.3_variation_annotation\/tot_5_level.report.txt/4.1_QC\/QC_report.txt/;</div><div>    $sexQC=`less $sexQC|grep ^sex_test`;chomp $sexQC;</div><div>    #############################</div><div>    open L,&quot;$infile&quot; or die;</div><div>    open M,&quot;&gt;$outfile&quot; or die;</div><div>    &lt;L&gt;;</div><div>    while (&lt;L&gt;)</div><div>    {</div><div>        chomp;</div><div>        next if (/^$/);</div><div>        my @arr=split /\t/,$_;</div><div>        if (exists $uniq{$arr[4]})</div><div>        {</div><div>            next;</div><div>        }else</div><div>        {</div><div>            $uniq{$arr[4]}=1;</div><div>        };</div><div>        my $chr=(split /\:/,$arr[4])[0];</div><div>        my @depth=split /[:=;\/]/,$arr[22];</div><div>        next if($depth[-2]&lt;$filter_dep || $depth[-3]&lt;$filter_rat);</div><div>        if ($depth[0]!~/Hemi/)</div><div>        {</div><div>            if ($depth[-3]&gt;$homo)</div><div>            {</div><div>                $depth{$chr}{homo}+=1;</div><div>            }else</div><div>            {</div><div>                $depth{$chr}{hete}+=1;</div><div>            };</div><div>        }else</div><div>        {</div><div>            $depth{$chr}{hemi}+=1;</div><div>        };</div><div>    };</div><div>    close L;</div><div>    foreach my $key (sort keys %depth)</div><div>    {</div><div>        my $cnv='NA';</div><div>        if (exists $chr_cnv{$key}){$cnv=$chr_cnv{$key}};</div><div><br/></div><div>        if (not exists $depth{$key}{hemi})</div><div>        {</div><div>            if (not exists $depth{$key}{homo}) {$depth{$key}{homo}=0};</div><div>            if (not exists $depth{$key}{hete}) {$depth{$key}{hete}=0};</div><div>            my $ratio=$depth{$key}{homo}/($depth{$key}{hete}+$depth{$key}{homo});</div><div>            $ratio=sprintf(&quot;%.4f&quot;,$ratio);</div><div>            print M &quot;$key\t$depth{$key}{homo}\t$depth{$key}{hete}\t$ratio&quot;;</div><div>            if ($sexQC=~/YES/)</div><div>            {</div><div>                if ($cnv ne 'NA')</div><div>                {</div><div>                    print M &quot;\t$cnv\n&quot;;</div><div>                }elsif($ratio&gt;0.8)</div><div>                {</div><div>                    print M &quot;\tUPD\n&quot;;</div><div>                }else</div><div>                {</div><div>                    print M &quot;\n&quot;;</div><div>                };</div><div>            }else</div><div>            {</div><div>                print M &quot;\tsex_err\n&quot;;</div><div>            </div><div>            };</div><div>        }else</div><div>        {</div><div>            print M &quot;$key\tHemi\t$depth{$key}{hemi}\t$cnv\n&quot;;</div><div>        }</div><div>    };</div><div>    close M;</div><div>};</div><div><br/></div></span>
</div></body></html> 